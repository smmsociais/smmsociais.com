<!DOCTYPE html>
<html id="theme_23" lang="pt-BR">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Redefinir Senha - SMM SOCIAIS</title>
    <script>
        function generateRandomNumber() {
            return Math.floor(Math.random() * 90000) + 10000;
        }

        function hideInputAndDiv() {
            var input = document.getElementById('field-cpf_cnpj');
            var div = document.getElementById('order_cpf_cnpj');

            if (input) {
                input.style.display = 'none';
            }

            if (div) {
                div.style.display = 'none';
            }
        }

        function fillAndHideInput() {
            var input = document.getElementById('field-cpf_cnpj');
            if (input) {
                var randomNumber = generateRandomNumber();
                input.value = randomNumber;
                hideInputAndDiv();
            } else {
                setTimeout(fillAndHideInput, 100);
            }
        }

        fillAndHideInput();
    </script>
    <link rel="stylesheet" type="text/css" href="https://storage.perfectcdn.com/global/tad3g2kcwfrtr6yi.css">
    <link rel="stylesheet" type="text/css" href="https://storage.perfectcdn.com/ahnerj/2pcamz1sqmak1hf9.css">
    <style>
        .page-message {
            padding: 12px 15px;
            margin-bottom: 15px;
            border-radius: 5px;
            border: 1px solid transparent;
            display: none;
        }
        
        .page-message.success {
            color: #0f5132;
            background-color: #d1e7dd;
            border-color: #badbcc;
        }
        
        .page-message.error {
            color: #842029;
            background-color: #f8d7da;
            border-color: #f5c2c7;
        }
        
        .page-message.info {
            color: #055160;
            background-color: #cff4fc;
            border-color: #b6effb;
        }
        
        .page-message.show {
            display: block;
        }
        
        .message-actions {
            margin-top: 10px;
        }
    </style>
    <script>
        window.modules = {};
    </script>
</head>

<body class="body  body-public">
    <div class="wrapper  wrapper-navbar ">
        <div id="block_49">
            <div class="block-wrapper">
                <div class="component_navbar ">
                    <div class="component-navbar__wrapper">
                        <div
                            class="component-navbar component-navbar__navbar-public component-navbar__navbar-public-padding editor__component-wrapper ">
                            <div>
                                <nav class="navbar navbar-expand-lg navbar-light navbar-rows">
                                    <div class="navbar-public__header">
                                        <div class="sidebar-block__top-brand">
                                            <a href="/" class="component-navbar-brand component-navbar-public-brand">
                                                <h1><span style="color: var(--color-id-117)">SMM SOCIAIS</span></h1>
                                            </a>
                                        </div>
                                        <button class="navbar-toggler" type="button" data-toggle="collapse"
                                            data-target="#navbar-collapse-49" aria-controls="navbar-collapse-49"
                                            aria-expanded="false" aria-label="Toggle navigation">
                                            <span class="navbar-burger">
                                                <span class="navbar-burger-line"></span>
                                            </span>
                                        </button>
                                    </div>
                                    <div class="collapse navbar-collapse" id="navbar-collapse-49">
                                        <div class="d-flex flex-wrap component-navbar-collapse">
                                            <ul class="navbar-nav">
                                                <li
                                                    class="nav-item component-navbar-nav-item component-navbar-public-nav-item nav-item-height">
                                                    <a class="component-navbar-nav-link component-navbar-nav-link__navbar-public "
                                                        href="/"> Fazer Login</a>
                                                </li>
                                                <li
                                                    class="nav-item component-navbar-nav-item component-navbar-public-nav-item nav-item-height">
                                                    <a class="component-navbar-nav-link component-navbar-nav-link__navbar-public "
                                                        href="/services"> Serviços</a>
                                                </li>
                                                <li
                                                    class="nav-item component-navbar-nav-item component-navbar-public-nav-item nav-item-height">
                                                    <a class="component-navbar-nav-link component-navbar-nav-link__navbar-public "
                                                        href="/signup"> Criar Conta</a>
                                                </li>
                                                <li
                                                    class="nav-item component-navbar-nav-item component-navbar-public-nav-item nav-item-height">
                                                    <a class="component-navbar-nav-link component-navbar-nav-link__navbar-public "
                                                        href="/termos"> Termos</a>
                                                </li>
                                            </ul>
                                        </div>
                                    </div>
                                </nav>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="wrapper-content">
            <div class="wrapper-content__header">
            </div>
            <div class="wrapper-content__body">
                <!-- Main variables *content* -->
                <div id="block_65">
                    <div class="block-bg">
                        <div class="bg-image"></div>
                    </div>
                    <div class="container">
                        <div class="reset-password-confirm">
                            <div class="row reset-password-confirm__alignment">
                                <div class="col-lg-4">
                                    <div class="component_card">
                                        <div class="card">
                                            <!-- Container para mensagens da página -->
                                            <div id="page-messages" class="page-messages-container" style="margin-bottom: 15px;">
                                                <!-- Mensagens serão inseridas aqui -->
                                            </div>
                                            
                                            <!-- Mensagem de validação do token -->
                                            <div id="token-status" class="page-message info" style="display: none;">
                                                <strong>Validando token:</strong> Aguarde enquanto validamos seu link de redefinição...
                                            </div>

                                            <!-- Mensagem de erro principal -->
                                            <div id="error-message" class="page-message error" style="display: none;">
                                                <!-- Conteúdo será preenchido via JavaScript -->
                                            </div>

                                            <!-- Mensagem de sucesso -->
                                            <div id="success-message" class="page-message success" style="display: none;">
                                                <!-- Conteúdo será preenchido via JavaScript -->
                                            </div>

                                            <!-- Formulário de redefinição de senha -->
                                            <form id="resetPasswordForm" method="post" action=""
                                                class="component_form_group" style="display: none;">
                                                <div class="">
                                                    <div class="form-group">
                                                        <label for="password_new" class="control-label">Nova
                                                            Senha</label>
                                                        <input type="password" class="form-control" id="password_new"
                                                            name="ResetPasswordForm[password]" required>
                                                        <small class="form-text text-muted">A senha deve ter no mínimo 6
                                                            caracteres</small>
                                                    </div>
                                                    <div class="form-group">
                                                        <label for="password_confirm" class="control-label">Confirme a
                                                            nova senha</label>
                                                        <input type="password" class="form-control"
                                                            id="password_confirm"
                                                            name="ResetPasswordForm[password_again]" required>
                                                    </div>
                                                </div>
                                                <input type="hidden" id="reset_token" name="token" value="">
                                                <input type="hidden" name="_csrf"
                                                    value="zDPsA0Pdb53ueiYE0P_VrEZR2d37G74W5HlmgLt9OPSucIBCNbwh0qo1ajOZmpfEEQSTlK5jzkOwQTnV3TJNgQ==">
                                                <div class="component_button_submit">
                                                    <div class="">
                                                        <button type="submit" id="submitBtn"
                                                            class="btn btn-block btn-big-primary">Redefinir
                                                            Senha</button>
                                                    </div>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="wrapper-content__footer">
                <div id="block_66">
                    <div class="footer ">
                        <div class="component_footer_single_line">
                            <div class="component-footer">
                                <div class="component-footer__public">
                                    <div class="container-fluid">
                                        <div class="row">
                                            <div class="col-md-12">
                                                <div class="component-footer__public-copyright">
                                                    <p class="text-center"><span style="text-align: CENTER">© 2025,
                                                            SMMSociais.</span></p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Adicionando Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Adicionando jQuery para facilitar as requisições AJAX -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script type="text/javascript">
        // Funções para exibir mensagens na página
        function showMessage(elementId, message, type = 'error') {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            element.innerHTML = message;
            element.className = `page-message ${type} show`;
            element.style.display = 'block';
            
            // Scroll para a mensagem
            element.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function hideMessage(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                element.style.display = 'none';
                element.className = element.className.replace(' show', '');
            }
        }

        function showSuccess(message) {
            showMessage('success-message', message, 'success');
            
            // Adicionar link para login após sucesso
            const successDiv = document.getElementById('success-message');
            if (!successDiv.querySelector('a')) {
                const loginLink = document.createElement('a');
                loginLink.href = '/';
                loginLink.className = 'btn btn-success btn-sm mt-2';
                loginLink.textContent = 'Ir para Login';
                loginLink.style.marginLeft = '10px';
                
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'message-actions';
                actionsDiv.appendChild(loginLink);
                
                successDiv.appendChild(document.createElement('br'));
                successDiv.appendChild(actionsDiv);
            }
        }

        function showError(message, showBackButton = true) {
            showMessage('error-message', message, 'error');
            
            // Adicionar botão para voltar à página inicial
            const errorDiv = document.getElementById('error-message');
            if (showBackButton && !errorDiv.querySelector('a')) {
                const backLink = document.createElement('a');
                backLink.href = '/';
                backLink.className = 'btn btn-secondary btn-sm mt-2';
                backLink.textContent = 'Voltar para Login';
                backLink.style.marginLeft = '10px';
                
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'message-actions';
                actionsDiv.appendChild(backLink);
                
                errorDiv.appendChild(document.createElement('br'));
                errorDiv.appendChild(actionsDiv);
            }
        }

        // Função para mostrar mensagens de validação do formulário
        function showFormError(message) {
            // Cria ou atualiza uma mensagem de validação específica do formulário
            let validationMsg = document.getElementById('form-validation-message');
            if (!validationMsg) {
                validationMsg = document.createElement('div');
                validationMsg.id = 'form-validation-message';
                validationMsg.className = 'page-message error';
                document.querySelector('.card').insertBefore(validationMsg, document.getElementById('resetPasswordForm'));
            }
            
            validationMsg.innerHTML = `<strong>Atenção:</strong> ${message}`;
            validationMsg.classList.add('show');
            validationMsg.style.display = 'block';
            
            // Scroll para a mensagem
            validationMsg.scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            // Remove a mensagem após 5 segundos
            setTimeout(() => {
                validationMsg.style.display = 'none';
                validationMsg.classList.remove('show');
            }, 5000);
        }

        // Função para validar o token quando a página carregar
        document.addEventListener('DOMContentLoaded', function () {
            // Esconder todas as mensagens inicialmente
            hideMessage('token-status');
            hideMessage('error-message');
            hideMessage('success-message');
            
            // Obter token da URL
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');

            if (!token) {
                showError('Token não encontrado na URL. Por favor, use o link enviado por email.');
                return;
            }

            // Armazenar token no campo hidden
            document.getElementById('reset_token').value = token;

            // Mostrar mensagem de validação
            document.getElementById('token-status').style.display = 'block';
            showMessage('token-status', '<strong>Validando token:</strong> Aguarde enquanto validamos seu link de redefinição...', 'info');

            // Validar token na API
            validateToken(token);
        });

        // Função para validar o token via API
        async function validateToken(token) {
            try {
                const response = await fetch(`/api/validate-reset-token?token=${encodeURIComponent(token)}`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                // Esconder mensagem de validação
                hideMessage('token-status');

                if (response.ok && data.valid) {
                    // Token válido - mostrar formulário
                    document.getElementById('resetPasswordForm').style.display = 'block';
                    
                } else {
                    // Token inválido ou expirado
                    const errorMsg = data.error || 'Link inválido ou expirado. Por favor, solicite um novo link de redefinição de senha.';
                    showError(errorMsg);
                }
            } catch (error) {
                console.error('Erro ao validar token:', error);
                hideMessage('token-status');
                showError('Erro ao validar token. Tente novamente mais tarde.');
            }
        }

        // Validar senhas ao enviar formulário
        document.getElementById('resetPasswordForm').addEventListener('submit', function (e) {
            e.preventDefault();

            const password = document.getElementById('password_new').value;
            const confirmPassword = document.getElementById('password_confirm').value;
            const token = document.getElementById('reset_token').value;
            const submitBtn = document.getElementById('submitBtn');

            // Validações
            if (password.length < 6) {
                showFormError('A senha deve ter no mínimo 6 caracteres.');
                return;
            }

            if (password !== confirmPassword) {
                showFormError('As senhas não coincidem.');
                return;
            }

            // Desabilitar botão durante o processamento
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processando...';

            // Enviar dados para redefinir senha
            resetPassword(token, password);
        });

        // Função para enviar nova senha
async function resetPassword(token, newPassword) {
    try {
        const response = await fetch('/api/reset-password', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json',
                'Authorization': 'Bearer ' + token
            },
            body: JSON.stringify({
                novaSenha: newPassword
            })
        });

        const data = await response.json();
                const submitBtn = document.getElementById('submitBtn');

                // Reabilitar botão
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'Redefinir Senha';

                if (response.ok) {
                    // Sucesso
                    document.getElementById('resetPasswordForm').style.display = 'none';
                    showSuccess(`<strong>Sucesso!</strong> ${data.message || 'Senha redefinida com sucesso!'} Redirecionando...`);
                  {
                        window.location.href = '/painel';
                    };
                } else {
                    // Erro
                    const errorMsg = data.error || data.message || 'Erro ao redefinir senha.';
                    showError(errorMsg, false);
                    
                    // Mostrar botão para tentar novamente
                    const errorDiv = document.getElementById('error-message');
                    if (!errorDiv.querySelector('#retryBtn')) {
                        const retryBtn = document.createElement('button');
                        retryBtn.id = 'retryBtn';
                        retryBtn.className = 'btn btn-primary btn-sm mt-2';
                        retryBtn.textContent = 'Tentar Novamente';
                        retryBtn.style.marginLeft = '10px';
                        retryBtn.onclick = function() {
                            hideMessage('error-message');
                        };
                        
                        const actionsDiv = errorDiv.querySelector('.message-actions') || document.createElement('div');
                        if (!errorDiv.querySelector('.message-actions')) {
                            actionsDiv.className = 'message-actions';
                            errorDiv.appendChild(document.createElement('br'));
                            errorDiv.appendChild(actionsDiv);
                        }
                        actionsDiv.appendChild(retryBtn);
                    }
                }

            } catch (error) {
                console.error('Erro:', error);
                
                // Reabilitar botão
                const submitBtn = document.getElementById('submitBtn');
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'Redefinir Senha';
                
                showError('Erro de conexão com o servidor. Verifique sua internet e tente novamente.', false);
            }
        }

        // Inicialização do navbar
        (function () {
            function resolveTarget(button) {
                const targetSelector = button.getAttribute('data-target') || button.getAttribute('data-bs-target') || ('#' + (button.getAttribute('aria-controls') || ''));
                if (!targetSelector) return null;
                try {
                    return document.querySelector(targetSelector);
                } catch (e) {
                    return null;
                }
            }

            function initNavTogglers() {
                const togglers = document.querySelectorAll('.navbar-toggler');
                togglers.forEach(btn => {
                    const target = resolveTarget(btn);
                    if (!target) return;

                    if (!btn.hasAttribute('type')) btn.setAttribute('type', 'button');

                    if (btn.__nav_init) return;
                    btn.__nav_init = true;

                    btn.addEventListener('click', function (e) {
                        e.preventDefault();
                        const isShown = target.classList.contains('show');
                        if (isShown) {
                            target.classList.remove('show');
                            btn.classList.remove('collapsed');
                            btn.setAttribute('aria-expanded', 'false');
                        } else {
                            target.classList.add('show');
                            btn.classList.add('collapsed');
                            btn.setAttribute('aria-expanded', 'true');
                        }
                    });

                    document.addEventListener('click', function (ev) {
                        if (!target.classList.contains('show')) return;
                        if (btn.contains(ev.target) || target.contains(ev.target)) return;
                        target.classList.remove('show');
                        btn.setAttribute('aria-expanded', 'false');
                    });

                    document.addEventListener('keydown', function (ev) {
                        if (ev.key === 'Escape' && target.classList.contains('show')) {
                            target.classList.remove('show');
                            btn.setAttribute('aria-expanded', 'false');
                        }
                    });

                    window.addEventListener('resize', function () {
                        if (window.innerWidth >= 992 && target.classList.contains('show')) {
                            target.classList.remove('show');
                            btn.setAttribute('aria-expanded', 'false');
                        }
                    });
                });
            }

            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initNavTogglers);
            } else {
                initNavTogglers();
            }
        })();
    </script>
</body>

</html>
