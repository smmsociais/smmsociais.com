<!DOCTYPE html>
<html id="theme_23" lang="pt-BR">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Painel - SMM SOCIAIS</title>
    <style>
        /* painel.html */
        body {
            visibility: hidden;
            opacity: 0;
            transition: opacity 240ms ease;
        }

        body.loaded {
            visibility: visible;
            opacity: 1;
        }

        #page-loader {
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.9);
            z-index: 9999;
        }

        .hidden {
            display: none !important;
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .alert {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            min-width: 300px;
        }

        /* Estilo para a mensagem de sucesso */
        .success-message {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 12px 20px;
            border-radius: 4px;
            margin-top: 20px;
            text-align: center;
        }

        /* Ajustes para dispositivos pequenos */
        @media (max-width: 991.98px) {
            .success-message-mobile {
                margin: 20px 0;
                order: 1;
            }

            .new_order-block .row {
                display: flex;
                flex-direction: column;
            }

            .new_order-block .col-lg-7 {
                order: 2;
            }

            .new_order-block .col-lg-5 {
                order: 3;
            }
        }

        /* Estilo do botão do WhatsApp */
        #whatsapp-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #25d366;
            border-radius: 50%;
            padding: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            z-index: 9999;
            transition: transform .2s;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 56px;
            height: 56px;
            text-decoration: none;
        }

        #whatsapp-button:hover {
            transform: scale(1.1);
            background-color: #1da851;
        }

        #whatsapp-button img {
            width: 32px;
            height: 32px;
            filter: invert(1);
        }

        /* Search results (lista de serviços sugeridos) */
        #service-search-results {
            position: relative;
            margin-top: 6px;
            max-height: 360px;
            overflow: auto;
            border-radius: 6px;
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.08);
            background: #fff;
            border: 1px solid #eee;
            z-index: 9998;
            font-size: 14px;
        }

        .service-result-item {
            padding: 10px 12px;
            display: flex;
            gap: 10px;
            align-items: flex-start;
            cursor: pointer;
            border-bottom: 1px solid rgba(0, 0, 0, 0.03);
        }

        .service-result-item:last-child {
            border-bottom: none;
        }

        .service-result-item:hover {
            background: rgba(0, 0, 0, 0.02);
        }

        .service-result-icon {
            font-size: 20px;
            width: 36px;
            text-align: center;
            line-height: 20px;
        }

        .service-result-body {
            flex: 1;
            min-width: 0;
        }

        .service-result-title {
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .service-result-sub {
            font-size: 12px;
            color: #666;
            margin-top: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .search-no-results {
            padding: 12px;
            color: #777;
        }

        /* Estilo para o emoji no select customizado */
        .custom-select-btn .emoji {
            font-size: 16px;
            line-height: 1;
        }

        .custom-select-list .emoji {
            font-size: 16px;
            line-height: 1;
            width: 20px;
            text-align: center;
        }

        /* Estilo para imagens no select customizado */
        .custom-select-btn img {
            width: 20px;
            height: 20px;
            object-fit: contain;
            display: inline-block;
        }

        .custom-select-list img {
            width: 20px;
            height: 20px;
            object-fit: contain;
            display: inline-block;
        }

        /* Estilos para o botão de busca (lupa) */
        .input-wrapper button {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            padding: 0px 2px;
            background: none;
            border: none;
            left: 12px;
            z-index: 10;
            /* Adicione esta linha */
            color: #666;
            /* Adicione cor para melhor visibilidade */
        }

        .input-wrapper button .fas.fa-search {
            font-size: 16px;
            /* Tamanho adequado */
        }

        /* Ajuste para o input de busca */
        #template-input {
            padding-left: 40px !important;
            /* Garante espaço para o ícone */
            width: 100%;
        }

        /* Ajuste específico para dispositivos móveis */
        @media (max-width: 768px) {
            .input-wrapper button {
                left: 10px;
            }

            .input-wrapper button .fas.fa-search {
                font-size: 14px;
            }

            #template-input {
                padding-left: 36px !important;
            }
        }

        /* Forçar exibição do ícone em todos os dispositivos */
        #new-order-search .fa-search {
            display: inline-block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }

        /* Garantir que o botão seja clicável */
        .input-wrapper button {
            pointer-events: auto !important;
        }
    </style>
    <script>

        // coloque isto no topo do seu <script>, antes de qualquer função que use categoryImages
        const categoryImages = {
            'Instagram': 'https://i.imgur.com/Z0xqxOg.png',
            'Curtidas no Instagram': '❤️',
            'Seguidores Brasileiros no Instagram': 'https://i.imgur.com/hHSv4MC.png',
            'Curtidas Brasileiras no Instagram': 'https://i.imgur.com/hHSv4MC.png',
            'TikTok': 'https://i.imgur.com/SbNaQUY.png'
            // adicione mais mapeamentos conforme as categorias reais retornadas pela API
        };

        // Função para obter parâmetros da URL
        function getUrlParams() {
            const params = new URLSearchParams(window.location.search);
            const paramsObj = {};
            for (const [key, value] of params) {
                paramsObj[key] = value;
            }
            return paramsObj;
        }

        // Função para obter o token do localStorage
        function loadToken() {
            const token = localStorage.getItem('authToken') ||
                localStorage.getItem('token') ||
                localStorage.getItem('user_token') ||
                localStorage.getItem('auth') ||
                getToken();
            return token;
        }

        // Função para carregar saldo do usuário
        async function loadUserBalance() {
            const token = loadToken();

            if (!token) {
                console.error("Token não encontrado.");
                // Definir saldo como R$ 0,00 em caso de erro
                const balanceElement = document.querySelector('.component-navbar-balance-item__navbar-private');
                if (balanceElement) {
                    balanceElement.textContent = 'R$ 0,00';
                }
                return 0;
            }

            try {
                const response = await fetch('https://smmsociais.com/api/get_saldo', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error('Erro ao carregar saldo');
                }

                const balanceData = await response.json();

                // Formatar o saldo como moeda brasileira
                const formattedBalance = new Intl.NumberFormat('pt-BR', {
                    style: 'currency',
                    currency: 'BRL'
                }).format(balanceData.saldo || 0);

                // Atualizar o saldo na navbar
                const balanceElement = document.querySelector('.component-navbar-balance-item__navbar-private');
                if (balanceElement) {
                    balanceElement.textContent = formattedBalance;
                }

                return balanceData.saldo;

            } catch (error) {
                console.error('Erro ao carregar saldo:', error);
                // Definir saldo como R$ 0,00 em caso de erro
                const balanceElement = document.querySelector('.component-navbar-balance-item__navbar-private');
                if (balanceElement) {
                    balanceElement.textContent = 'R$ 0,00';
                }
                return 0;
            }
        }

        // Função para obter informações do usuário
        async function getUserInfo() {
            const token = loadToken();

            if (!token) {
                console.error("Token não encontrado.");
                return null;
            }

            try {
                const response = await fetch('https://smmsociais.com/api/account', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    // mostra o status e corpo para debug
                    const txt = await response.text().catch(() => null);
                    console.error('Erro ao carregar informações do usuário. status:', response.status, txt);
                    throw new Error('Erro ao carregar informações do usuário');
                }

                const userData = await response.json();
                console.log('getUserInfo response:', userData);

                // Normaliza campos esperados
                const normalized = {
                    userId: userData.userId || userData.id || userData._id || null,
                    nome_usuario: userData.nome_usuario || userData.nome || null,
                    email: userData.email || null,
                    token: userData.token || token
                };

                return normalized;
            } catch (error) {
                console.error('Erro ao carregar informações do usuário:', error);
                return null;
            }
        }

        function generateRandomNumber() {
            return Math.floor(Math.random() * 90000) + 10000;
        }

        function hideInputAndDiv() {
            var input = document.getElementById('field-cpf_cnpj');
            var div = document.getElementById('order_cpf_cnpj');

            if (input) {
                input.style.display = 'none';
            }

            if (div) {
                div.style.display = 'none';
            }
        }

        function fillAndHideInput() {
            var input = document.getElementById('field-cpf_cnpj');
            if (input) {
                var randomNumber = generateRandomNumber();
                input.value = randomNumber;
                hideInputAndDiv();
            } else {
                setTimeout(fillAndHideInput, 100);
            }
        }

        // Função para carregar serviços da API
        function loadServices() {
            return fetch('https://smmsociais.com/api/servico')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Erro ao carregar serviços da API');
                    }
                    return response.json();
                })
                .then(services => {
                    renderServices(services);

                    // Garantir que a primeira categoria seja selecionada
                    setTimeout(() => {
                        const categorySelect = document.getElementById('orderform-category');
                        if (categorySelect && categorySelect.options.length > 0) {
                            categorySelect.selectedIndex = 0;
                            const event = new Event('change');
                            categorySelect.dispatchEvent(event);
                        }
                    }, 100);

                    return services;
                })
                .catch(error => {
                    console.error('Erro ao carregar serviços:', error);
                    const serviceSelect = document.getElementById('orderform-service');
                    if (serviceSelect) {
                        serviceSelect.innerHTML = '<option value="">Erro ao carregar serviços</option>';
                    }
                    return [];
                });
        }
        // Função para renderizar serviços no formulário
        function renderServices(services) {
            const serviceSelect = document.getElementById('orderform-service');
            if (!serviceSelect) return;

            // Limpar opções existentes
            serviceSelect.innerHTML = '';

            // Adicionar opção padrão
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'Selecione um serviço';
            serviceSelect.appendChild(defaultOption);

            // Adicionar serviços da API
            services.forEach(service => {
                const option = document.createElement('option');
                option.value = service.id_servico;
                option.textContent = service.nome;
                option.setAttribute('data-price', service.preco_1000);
                option.setAttribute('data-min', service.minimo);
                option.setAttribute('data-max', service.maximo);
                option.setAttribute('data-description', service.descricao);
                option.setAttribute('data-rede', service.rede);
                option.setAttribute('data-tipo', service.tipo);
                serviceSelect.appendChild(option);
            });

            // Verificar se há um serviço específico na URL
            const urlParams = getUrlParams();
            const serviceIdFromUrl = urlParams.service;

            if (serviceIdFromUrl) {
                // Tentar selecionar o serviço da URL
                selectServiceById(serviceIdFromUrl, services);
            } else {
                // Preencher automaticamente com o primeiro serviço se não houver parâmetro
                if (services.length > 0) {
                    autoSelectFirstService(services);
                }
            }

            // Atualizar categorias com base nos serviços
            updateCategories(services);

            // Configurar event listeners
            setupServiceEventListeners(services);
        }

        // Função para selecionar serviço por ID
        function selectServiceById(serviceId, services) {
            const serviceSelect = document.getElementById('orderform-service');
            if (!serviceSelect) return;

            // Encontrar o serviço pelo ID
            const service = services.find(s => s.id_servico == serviceId);

            if (service) {
                // Encontrar a opção correspondente no select
                for (let i = 0; i < serviceSelect.options.length; i++) {
                    if (serviceSelect.options[i].value == serviceId) {
                        serviceSelect.selectedIndex = i;

                        // Disparar o evento change para atualizar todos os campos
                        const event = new Event('change');
                        serviceSelect.dispatchEvent(event);

                        // Garantir que os campos sejam exibidos
                        showServiceFields();

                        console.log(`Serviço selecionado automaticamente: ${service.nome} (ID: ${serviceId})`);
                        return;
                    }
                }
            }

            // Se não encontrou o serviço, usar o primeiro disponível
            console.warn(`Serviço com ID ${serviceId} não encontrado. Selecionando primeiro serviço disponível.`);
            if (services.length > 0) {
                autoSelectFirstService(services);
            }
        }

        // Função para preencher automaticamente o primeiro serviço
        function autoSelectFirstService(services) {
            const serviceSelect = document.getElementById('orderform-service');
            if (serviceSelect && serviceSelect.options.length > 1) {
                // Selecionar o primeiro serviço (índice 1, pois o índice 0 é a opção padrão)
                serviceSelect.selectedIndex = 1;

                // Disparar o evento change para atualizar todos os campos
                const event = new Event('change');
                serviceSelect.dispatchEvent(event);

                // Garantir que os campos sejam exibidos
                showServiceFields();
            }
        }

        // Função para mostrar campos do serviço
        function showServiceFields() {
            const linkField = document.getElementById('link_field');
            const quantityField = document.getElementById('quantity_field');
            const serviceDescription = document.getElementById('service_description');

            if (linkField) linkField.classList.remove('hidden');
            if (quantityField) quantityField.classList.remove('hidden');
            if (serviceDescription) serviceDescription.classList.remove('hidden');
        }

        // helper: procura ícone/emoji no map categoryImages (case-insensitive)
        function getCategoryImageForName(name) {
            if (!name) return null;
            const keys = Object.keys(categoryImages || {});
            for (let k of keys) {
                if (String(k).toLowerCase() === String(name).toLowerCase()) return categoryImages[k];
            }
            for (let k of keys) {
                if (String(name).toLowerCase().includes(String(k).toLowerCase())) return categoryImages[k];
            }
            return null;
        }

        // Na função updateCategories, modifique para carregar a primeira categoria:
        function updateCategories(services) {
            const categorySelect = document.getElementById('orderform-category');
            if (!categorySelect) return;

            // Limpar categorias existentes, mantendo apenas a opção padrão
            while (categorySelect.options.length > 1) {
                categorySelect.remove(1);
            }

            const categories = new Map();

            services.forEach(service => {
                const name = (service.categoria || service.category_name || service.category || '').toString().trim();
                if (!name) return;
                if (categories.has(name)) return;

                let icon = service.category_icon || getCategoryImageForName(name) || null;
                categories.set(name, icon);
            });

            // --- preencher options sem duplicar emoji no texto ---
            categories.forEach((icon, name) => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;  // ← APENAS O NOME, sem emoji!

                // Adicionar o ícone apenas no data-icon
                if (icon) {
                    option.setAttribute('data-icon', icon);
                }

                categorySelect.appendChild(option);
            });

            // --- ADICIONE ESTA PARTE PARA SELECIONAR A PRIMEIRA CATEGORIA ---
            if (categorySelect.options.length > 1) {
                // Seleciona a primeira categoria (índice 1, pois índice 0 era "Favorite services")
                categorySelect.selectedIndex = 0; // Agora será índice 0 após remover "Favorite services"

                // Dispara o evento change para filtrar os serviços
                const event = new Event('change');
                categorySelect.dispatchEvent(event);
            }

            // ---------------- custom dropdown (substitui select visualmente) ----------------
            function createCustomCategoryDropdown(selectEl) {
                if (!selectEl || selectEl.__custom_inited) return;
                selectEl.__custom_inited = true;

                // wrapper
                const wrapper = document.createElement('div');
                wrapper.className = 'custom-select-wrapper';
                wrapper.style.position = 'relative';
                wrapper.style.width = selectEl.offsetWidth ? selectEl.offsetWidth + 'px' : '100%';

                // button (visível)
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'custom-select-btn';
                btn.style.width = '100%';
                btn.style.display = 'flex';
                btn.style.alignItems = 'center';
                btn.style.gap = '8px';
                btn.style.padding = '8px 12px';
                btn.style.border = '1px solid #ddd';
                btn.style.borderRadius = '4px';
                btn.style.background = '#fff';
                btn.style.textAlign = 'left';
                btn.style.cursor = 'pointer';
                btn.style.fontSize = '14px';
                btn.setAttribute('aria-haspopup', 'listbox');

                // preview img / emoji
                const iconImg = document.createElement('img');
                iconImg.style.width = '20px';
                iconImg.style.height = '20px';
                iconImg.style.objectFit = 'contain';
                iconImg.style.display = 'none';
                iconImg.alt = '';

                const iconEmoji = document.createElement('span');
                iconEmoji.className = 'emoji';
                iconEmoji.style.fontSize = '16px';
                iconEmoji.style.display = 'none';
                iconEmoji.style.lineHeight = '1';

                const labelSpan = document.createElement('span');
                labelSpan.className = 'custom-select-label';
                labelSpan.style.flex = '1';
                labelSpan.style.textAlign = 'left';
                labelSpan.style.overflow = 'hidden';
                labelSpan.style.textOverflow = 'ellipsis';
                labelSpan.style.whiteSpace = 'nowrap';
                labelSpan.textContent = selectEl.options[selectEl.selectedIndex]?.text || 'Selecione uma categoria';

                btn.appendChild(iconImg);
                btn.appendChild(iconEmoji);
                btn.appendChild(labelSpan);

                // list (dropdown)
                const list = document.createElement('div');
                list.className = 'custom-select-list';
                list.setAttribute('role', 'listbox');
                list.style.position = 'absolute';
                list.style.left = '0';
                list.style.right = '0';
                list.style.zIndex = '9999';
                list.style.maxHeight = '260px';
                list.style.overflowY = 'auto';
                list.style.display = 'none';
                list.style.background = '#fff';
                list.style.border = '1px solid #ddd';
                list.style.borderRadius = '4px';
                list.style.boxShadow = '0 2px 10px rgba(0,0,0,.1)';
                list.style.marginTop = '4px';

                // build items from the select options
                function rebuild() {
                    list.innerHTML = '';
                    Array.from(selectEl.options).forEach(opt => {
                        if (!opt.value) return; // pular opção padrão
                        const item = document.createElement('div');
                        item.className = 'custom-option';
                        item.tabIndex = 0;
                        item.style.display = 'flex';
                        item.style.alignItems = 'center';
                        item.style.gap = '8px';
                        item.style.padding = '8px 12px';
                        item.style.cursor = 'pointer';
                        item.style.fontSize = '14px';
                        item.style.color = '#333';
                        item.style.borderBottom = '1px solid #f5f5f5';

                        const iconVal = opt.getAttribute('data-icon');
                        if (iconVal) {
                            const isEmoji = iconVal.length <= 4 && /\p{Emoji}/u.test(iconVal);
                            if (isEmoji) {
                                const sp = document.createElement('span');
                                sp.className = 'emoji';
                                sp.textContent = iconVal;
                                sp.style.fontSize = '16px';
                                sp.style.lineHeight = '1';
                                sp.style.width = '20px';
                                sp.style.textAlign = 'center';
                                item.appendChild(sp);
                            } else {
                                const im = document.createElement('img');
                                im.src = iconVal;
                                im.alt = '';
                                im.style.width = '20px';
                                im.style.height = '20px';
                                im.style.objectFit = 'contain';
                                item.appendChild(im);
                            }
                        } else {
                            const ph = document.createElement('span');
                            ph.style.width = '20px';
                            item.appendChild(ph);
                        }

                        const txt = document.createElement('span');
                        txt.textContent = opt.textContent;
                        txt.style.flex = '1';
                        item.appendChild(txt);

                        // Adiciona classe selected se for a opção atual
                        if (opt.selected) {
                            item.classList.add('selected');
                            item.style.backgroundColor = '#e8f0fe';
                            item.style.color = '#1a73e8';
                        }

                        item.addEventListener('click', () => {
                            selectEl.value = opt.value;
                            selectEl.dispatchEvent(new Event('change', { bubbles: true }));
                            updateButton();
                            close();
                        });

                        item.addEventListener('keydown', (ev) => {
                            if (ev.key === 'Enter' || ev.key === ' ') {
                                ev.preventDefault();
                                item.click();
                            }
                        });

                        item.addEventListener('focus', () => {
                            item.style.backgroundColor = '#f8f9fa';
                        });

                        item.addEventListener('blur', () => {
                            if (!opt.selected) {
                                item.style.backgroundColor = '';
                            }
                        });

                        list.appendChild(item);
                    });
                }

                function updateButton() {
                    const sel = selectEl.options[selectEl.selectedIndex];
                    const iconVal = sel ? sel.getAttribute('data-icon') : null;
                    labelSpan.textContent = sel ? sel.textContent : 'Selecione uma categoria';

                    // Atualiza visualmente qual opção está selecionada na lista
                    const allOptions = list.querySelectorAll('.custom-option');
                    allOptions.forEach(opt => {
                        opt.classList.remove('selected');
                        opt.style.backgroundColor = '';
                        opt.style.color = '#333';
                    });

                    if (sel && sel.value) {
                        const selectedOption = Array.from(list.querySelectorAll('.custom-option')).find(opt => {
                            const span = opt.querySelector('span:last-child');
                            return span && span.textContent === sel.textContent;
                        });
                        if (selectedOption) {
                            selectedOption.classList.add('selected');
                            selectedOption.style.backgroundColor = '#e8f0fe';
                            selectedOption.style.color = '#1a73e8';
                        }
                    }

                    if (!iconVal) {
                        iconImg.style.display = 'none';
                        iconEmoji.style.display = 'none';
                        return;
                    }
                    const isEmoji = iconVal.length <= 4 && /\p{Emoji}/u.test(iconVal);
                    if (isEmoji) {
                        iconEmoji.textContent = iconVal;
                        iconEmoji.style.display = 'inline-block';
                        iconImg.style.display = 'none';
                    } else {
                        iconImg.src = iconVal;
                        iconImg.style.display = 'inline-block';
                        iconEmoji.style.display = 'none';
                    }
                }

                function open() {
                    rebuild();
                    list.style.display = 'block';
                    btn.setAttribute('aria-expanded', 'true');
                    btn.style.borderColor = '#4d90fe';
                    btn.style.boxShadow = '0 0 0 2px rgba(77, 144, 254, 0.2)';
                }

                function close() {
                    list.style.display = 'none';
                    btn.setAttribute('aria-expanded', 'false');
                    btn.style.borderColor = '#ddd';
                    btn.style.boxShadow = 'none';
                }

                btn.addEventListener('click', (ev) => {
                    ev.preventDefault();
                    ev.stopPropagation();
                    if (list.style.display === 'block') {
                        close();
                    } else {
                        open();
                    }
                });

                btn.addEventListener('keydown', (ev) => {
                    if (ev.key === 'Enter' || ev.key === ' ') {
                        ev.preventDefault();
                        if (list.style.display === 'block') {
                            close();
                        } else {
                            open();
                        }
                    } else if (ev.key === 'Escape') {
                        close();
                    }
                });

                document.addEventListener('click', (ev) => {
                    if (!wrapper.contains(ev.target)) {
                        close();
                    }
                });

                // Navegação por teclado na lista
                list.addEventListener('keydown', (ev) => {
                    const items = Array.from(list.querySelectorAll('.custom-option'));
                    const currentIndex = items.findIndex(item => item === document.activeElement);

                    switch (ev.key) {
                        case 'ArrowDown':
                            ev.preventDefault();
                            const nextIndex = (currentIndex + 1) % items.length;
                            items[nextIndex]?.focus();
                            break;
                        case 'ArrowUp':
                            ev.preventDefault();
                            const prevIndex = currentIndex > 0 ? currentIndex - 1 : items.length - 1;
                            items[prevIndex]?.focus();
                            break;
                        case 'Enter':
                        case ' ':
                            ev.preventDefault();
                            document.activeElement?.click();
                            break;
                        case 'Escape':
                            ev.preventDefault();
                            close();
                            btn.focus();
                            break;
                    }
                });

                // insert into DOM: hide native select but keep it for form semantics
                selectEl.style.display = 'none';
                selectEl.parentNode.insertBefore(wrapper, selectEl);
                wrapper.appendChild(btn);
                wrapper.appendChild(list);

                // sync from outside changes
                selectEl.addEventListener('change', updateButton);

                // init
                updateButton();
            }

            // chamada: logo após popular as options
            createCustomCategoryDropdown(categorySelect);
            // --------------------------------------------------------------------------------
        }

        function autoSelectFirstCategory(categories) {
            const categorySelect = document.getElementById('orderform-category');
            if (categorySelect && categorySelect.options.length > 0) { // Agora inicia de 0
                // Selecionar a primeira categoria (índice 0)
                categorySelect.selectedIndex = 0;

                // Disparar o evento change para filtrar os serviços
                const event = new Event('change');
                categorySelect.dispatchEvent(event);
            }
        }

        // Função para configurar event listeners dos serviços
        function setupServiceEventListeners(services) {
            const categorySelect = document.getElementById('orderform-category');
            const serviceSelect = document.getElementById('orderform-service');
            const searchInput = document.getElementById('template-input');
            const quantityInput = document.getElementById('orderform-quantity');

            if (categorySelect) {
                categorySelect.addEventListener('change', function () {
                    filterServicesByCategory(this.value, services);
                });
            }

            if (serviceSelect) {
                serviceSelect.addEventListener('change', handleServiceChange);
            }

            if (searchInput) {
                searchInput.addEventListener('input', function () {
                    const searchTerm = this.value.toLowerCase();
                    const serviceSelect = document.getElementById('orderform-service');
                    const options = serviceSelect.querySelectorAll('option');

                    options.forEach(option => {
                        const text = option.textContent.toLowerCase();
                        if (text.includes(searchTerm) || option.value === '') {
                            option.style.display = '';
                        } else {
                            option.style.display = 'none';
                        }
                    });
                });
            }

            if (quantityInput) {
                quantityInput.addEventListener('input', handleQuantityChange);
            }
        }

        // Função para filtrar serviços por categoria
        function filterServicesByCategory(category, services) {
            const serviceSelect = document.getElementById('orderform-service');
            if (!serviceSelect) return;

            // Limpar opções existentes
            serviceSelect.innerHTML = '';

            // Adicionar opção padrão
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'Selecione um serviço'; // Removida verificação de "-1"
            serviceSelect.appendChild(defaultOption);

            // Filtrar e adicionar serviços
            const filteredServices = services.filter(service => service.categoria === category);
            filteredServices.forEach(service => {
                const option = document.createElement('option');
                option.value = service.id_servico;
                option.textContent = service.nome;
                option.setAttribute('data-price', service.preco_1000);
                option.setAttribute('data-min', service.minimo);
                option.setAttribute('data-max', service.maximo);
                option.setAttribute('data-description', service.descricao);
                option.setAttribute('data-rede', service.rede);
                option.setAttribute('data-tipo', service.tipo);
                serviceSelect.appendChild(option);
            });

            // Verificar se há um serviço específico na URL após o filtro
            const urlParams = getUrlParams();
            const serviceIdFromUrl = urlParams.service;

            if (serviceIdFromUrl) {
                // Tentar selecionar o serviço da URL mesmo após o filtro
                const serviceExists = filteredServices.some(s => s.id_servico == serviceIdFromUrl);
                if (serviceExists) {
                    selectServiceById(serviceIdFromUrl, filteredServices);
                } else if (filteredServices.length > 0) {
                    // Se o serviço da URL não está na categoria filtrada, usar o primeiro disponível
                    autoSelectFirstService(filteredServices);
                }
            } else if (filteredServices.length > 0) {
                // Preencher automaticamente com o primeiro serviço após filtro
                autoSelectFirstService(filteredServices);
            }
        }

        // Função para lidar com mudança de serviço
        function handleServiceChange() {
            const selectedOption = this.options[this.selectedIndex];
            const price = selectedOption.getAttribute('data-price');
            const description = selectedOption.getAttribute('data-description');
            const minQuantity = selectedOption.getAttribute('data-min');
            const maxQuantity = selectedOption.getAttribute('data-max');

            // Atualizar preço
            const quantityInput = document.getElementById('orderform-quantity');
            const currentQuantity = quantityInput ? quantityInput.value || minQuantity || 0 : 0;
            updateChargeField(price, currentQuantity);

            // Atualizar descrição
            const descriptionPanel = document.querySelector('.panel-description');
            if (description && descriptionPanel) {
                descriptionPanel.innerHTML = description.replace(/\n/g, '<br>');
                const serviceDescription = document.getElementById('service_description');
                if (serviceDescription) {
                    serviceDescription.classList.remove('hidden');
                }
            } else if (descriptionPanel) {
                descriptionPanel.innerHTML = '';
                const serviceDescription = document.getElementById('service_description');
                if (serviceDescription) {
                    serviceDescription.classList.add('hidden');
                }
            }

            // Mostrar/ocultar campos de link e quantidade
            const linkField = document.getElementById('link_field');
            const quantityField = document.getElementById('quantity_field');

            if (selectedOption.value) {
                if (linkField) linkField.classList.remove('hidden');
                if (quantityField) quantityField.classList.remove('hidden');

                // Configurar limites da quantidade
                if (quantityInput) {
                    if (minQuantity) {
                        quantityInput.min = minQuantity;
                        quantityInput.placeholder = `Mínimo: ${minQuantity}`;
                    }
                    if (maxQuantity) {
                        quantityInput.max = maxQuantity;
                        quantityInput.placeholder = `Mínimo: ${minQuantity || 0}, Máximo: ${maxQuantity}`;
                    }

                    // Preencher quantidade mínima automaticamente
                    if (minQuantity && !quantityInput.value) {
                        quantityInput.value = minQuantity;
                        updateChargeField(price, minQuantity);
                    }
                }
            } else {
                if (linkField) linkField.classList.add('hidden');
                if (quantityField) quantityField.classList.add('hidden');
            }
        }

        // Função para lidar com mudança de quantidade
        function handleQuantityChange() {
            const serviceSelect = document.getElementById('orderform-service');
            if (!serviceSelect) return;

            const selectedOption = serviceSelect.options[serviceSelect.selectedIndex];
            const price = selectedOption ? selectedOption.getAttribute('data-price') : null;

            if (price) {
                updateChargeField(price, this.value);
            }
        }

        // --- Calcular total (robusto) ---
        function calculateTotal(pricePer1000, quantity) {
            const price = parseFloat(pricePer1000);
            const qty = parseInt(String(quantity).replace(/[^\d]/g, ''), 10);

            if (isNaN(price) || isNaN(qty) || qty <= 0) return 0;
            return (price * qty) / 1000;
        }

        function updateChargeField(pricePer1000, quantity) {
            const chargeInput = document.getElementById('charge');
            if (!chargeInput) return;

            const qty = parseInt(String(quantity).replace(/[^\d]/g, ''), 10);

            if (pricePer1000 && !isNaN(qty) && qty > 0) {
                const total = calculateTotal(pricePer1000, qty);
                chargeInput.value = `R$ ${total.toFixed(2)} (R$ ${parseFloat(pricePer1000).toFixed(2)} por 1000)`;
            } else if (pricePer1000) {
                chargeInput.value = `R$ ${parseFloat(pricePer1000).toFixed(2)} por 1000`;
            } else {
                chargeInput.value = '';
            }
        }

        // Função para inicializar todos os campos com valores padrão
        function initializeDefaultFields() {
            const serviceSelect = document.getElementById('orderform-service');
            if (serviceSelect && serviceSelect.selectedIndex > 0) {
                // Garantir que os campos estejam visíveis
                showServiceFields();

                // Disparar evento change para preencher todos os campos
                const event = new Event('change');
                serviceSelect.dispatchEvent(event);
            }
        }

        // Função para mostrar notificação
        function showNotification(message, type = 'success') {
            const notifyWrapper = document.getElementById('notify-wrapper');
            if (!notifyWrapper) return;

            notifyWrapper.textContent = message;
            notifyWrapper.className = `alert alert-${type} mb-3`;
            notifyWrapper.style.display = 'block';

            setTimeout(() => {
                notifyWrapper.style.display = 'none';
            }, 5000);
        }

        // Função para mostrar mensagem de sucesso abaixo do container dos serviços
        function showSuccessMessage(message) {
            // Remover mensagem anterior se existir
            const existingMessage = document.getElementById('success-message');
            if (existingMessage) {
                existingMessage.remove();
            }

            // Criar nova mensagem
            const successMessage = document.createElement('div');
            successMessage.id = 'success-message';
            successMessage.className = 'success-message';

            // Adicionar classe específica para mobile
            if (window.innerWidth < 992) {
                successMessage.classList.add('success-message-mobile');
            }

            successMessage.textContent = message;

            // Inserir no local correto baseado no tamanho da tela
            if (window.innerWidth < 992) {
                // Em dispositivos pequenos: inserir entre os containers
                const servicesContainer = document.querySelector('.new_order-block .col-lg-7');
                const contactContainer = document.querySelector('.new_order-block .col-lg-5');
                const rowContainer = document.querySelector('.new_order-block .row');

                if (rowContainer && servicesContainer && contactContainer) {
                    // Remover a mensagem existente primeiro
                    const existingMsg = document.getElementById('success-message');
                    if (existingMsg) existingMsg.remove();

                    // Criar uma nova linha para a mensagem
                    const messageRow = document.createElement('div');
                    messageRow.className = 'col-12';
                    messageRow.appendChild(successMessage);

                    // Inserir após o container de serviços e antes do container de contato
                    rowContainer.insertBefore(messageRow, contactContainer);
                }
            } else {
                // Em dispositivos grandes: inserir após o container principal (comportamento original)
                const servicesContainer = document.querySelector('.new_order-block');
                if (servicesContainer) {
                    servicesContainer.parentNode.insertBefore(successMessage, servicesContainer.nextSibling);
                }
            }
        }

        // --- helper: escolhe endpoint baseado na rede ---
        function getApiEndpointForRede(rede) {
            if (!rede) return null;
            const r = String(rede).toLowerCase();
            if (r.includes('tiktok')) return 'https://smmsociais.com/api/criar_acao_tiktok';
            if (r.includes('instagram')) return 'https://smmsociais.com/api/criar_acao_instagram';
            // se quiser adicionar outras redes no futuro, acrescente aqui
            return null;
        }

        // criarAcao agora aceita endpoint opcional (string com URL completa)
        async function criarAcao(formData, tokenOpcional = null, endpoint = null) {
            const token = tokenOpcional || loadToken();
            if (!token) {
                throw new Error('Token de autenticação não encontrado');
            }

            // escolhe endpoint padrão se não passado
            const url = endpoint || 'https://smmsociais.com/api/criar_acao_tiktok';

            console.log('→ criarAcao endpoint:', url, ' token:', Boolean(token));
            console.log("Enviando token:", token);

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer 123456`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                if (!response.ok) {
                    // tenta ler texto primeiro (mais seguro), depois JSON
                    const text = await response.text().catch(() => null);
                    let errorMsg = text || `HTTP ${response.status}`;
                    try {
                        const json = text ? JSON.parse(text) : null;
                        if (json && json.error) errorMsg = json.error;
                    } catch (e) { /* não-JSON */ }

                    console.error('criar_acao response NOT OK:', response.status, errorMsg);
                    if (response.status === 401) {
                        throw new Error('Não autorizado');
                    }
                    throw new Error(errorMsg || 'Erro ao criar ação');
                }

                const result = await response.json();
                return result;

            } catch (error) {
                console.error('Erro na criação da ação:', error);
                throw error;
            }
        }

        // --- Ao mudar de serviço, configurar min/max corretamente ---
        function handleServiceChange() {
            const selectedOption = this.options[this.selectedIndex];
            if (!selectedOption) return;

            const price = selectedOption.getAttribute('data-price');
            const description = selectedOption.getAttribute('data-description');
            const minAttr = selectedOption.getAttribute('data-min');
            const maxAttr = selectedOption.getAttribute('data-max');

            // conversão segura de limites
            const minQuantity = (minAttr !== null && minAttr !== '') ? parseInt(minAttr, 10) : null;
            const maxQuantity = (maxAttr !== null && maxAttr !== '') ? parseInt(maxAttr, 10) : null;

            // Atualizar preço
            const quantityInput = document.getElementById('orderform-quantity');
            const currentQuantity = quantityInput ? quantityInput.value || (minQuantity !== null ? minQuantity : '') : '';
            updateChargeField(price, currentQuantity);

            // Atualizar descrição
            const descriptionPanel = document.querySelector('.panel-description');
            if (description && descriptionPanel) {
                descriptionPanel.innerHTML = description.replace(/\n/g, '<br>');
                const serviceDescription = document.getElementById('service_description');
                if (serviceDescription) {
                    serviceDescription.classList.remove('hidden');
                }
            } else if (descriptionPanel) {
                descriptionPanel.innerHTML = '';
                const serviceDescription = document.getElementById('service_description');
                if (serviceDescription) {
                    serviceDescription.classList.add('hidden');
                }
            }

            // Mostrar/ocultar campos de link e quantidade
            const linkField = document.getElementById('link_field');
            const quantityField = document.getElementById('quantity_field');

            if (selectedOption.value) {
                if (linkField) linkField.classList.remove('hidden');
                if (quantityField) quantityField.classList.remove('hidden');

                // Configurar limites da quantidade no input de forma segura
                if (quantityInput) {
                    if (minQuantity !== null) {
                        quantityInput.min = minQuantity;
                        quantityInput.placeholder = `Mínimo: ${minQuantity}`;
                    } else {
                        quantityInput.removeAttribute('min');
                    }

                    if (maxQuantity !== null) {
                        quantityInput.max = maxQuantity;
                        // placeholder já mostra mínimo; vamos juntar info se existir max
                        const minText = minQuantity !== null ? `Mínimo: ${minQuantity}, ` : '';
                        quantityInput.placeholder = `${minText}Máximo: ${maxQuantity}`;
                    } else {
                        quantityInput.removeAttribute('max');
                    }

                    // Preencher quantidade mínima automaticamente se estiver vazio
                    if (minQuantity !== null && !quantityInput.value) {
                        quantityInput.value = minQuantity;
                        updateChargeField(price, minQuantity);
                    }
                }
            } else {
                if (linkField) linkField.classList.add('hidden');
                if (quantityField) quantityField.classList.add('hidden');
            }
        }

        // --- Ao mudar a quantidade pelo input ---
        function handleQuantityChange() {
            const serviceSelect = document.getElementById('orderform-service');
            if (!serviceSelect) return;

            const selectedOption = serviceSelect.options[serviceSelect.selectedIndex];
            const price = selectedOption ? selectedOption.getAttribute('data-price') : null;

            // sanitiza a quantidade para números antes de atualizar
            const raw = this.value;
            const sanitized = raw ? String(raw).replace(/[^\d]/g, '') : '';
            if (sanitized !== raw) {
                // opcional: atualiza o campo para remover chars inválidos
                this.value = sanitized;
            }

            if (price) {
                updateChargeField(price, sanitized);
            }
        }

        // --- Envio do formulário com validação numérica correta (ajustada para escolher rota) ---
        async function handleFormSubmit(event) {
            event.preventDefault();

            const submitButton = event.target.querySelector('button[type="submit"]');
            const originalText = submitButton ? submitButton.textContent : 'Enviar';

            try {
                if (submitButton) {
                    submitButton.textContent = 'Enviando...';
                    submitButton.disabled = true;
                }
                document.body.classList.add('loading');

                // Obter dados do formulário
                const serviceSelect = document.getElementById('orderform-service');
                if (!serviceSelect || !serviceSelect.value) {
                    throw new Error('Por favor, selecione um serviço');
                }
                const selectedOption = serviceSelect.options[serviceSelect.selectedIndex];

                const linkInput = document.getElementById('orderform-link');
                const link = linkInput ? linkInput.value.trim() : '';
                if (!link) throw new Error('Por favor, informe o link');

                const quantityInput = document.getElementById('orderform-quantity');
                const quantityRaw = quantityInput ? quantityInput.value : '';
                const quantity = parseInt(String(quantityRaw).replace(/[^\d]/g, ''), 10);

                const minAttr = selectedOption.getAttribute('data-min');
                const maxAttr = selectedOption.getAttribute('data-max');
                const minQuantity = (minAttr !== null && minAttr !== '') ? parseInt(minAttr, 10) : null;
                const maxQuantity = (maxAttr !== null && maxAttr !== '') ? parseInt(maxAttr, 10) : null;

                // Validações numéricas
                if (isNaN(quantity) || quantity <= 0) {
                    throw new Error('Quantidade inválida para este serviço');
                }
                if (minQuantity !== null && quantity < minQuantity) {
                    throw new Error(`Quantidade abaixo do mínimo (${minQuantity})`);
                }
                if (maxQuantity !== null && quantity > maxQuantity) {
                    throw new Error(`Quantidade acima do máximo (${maxQuantity})`);
                }

                const pricePer1000 = selectedOption.getAttribute('data-price');
                const totalValue = calculateTotal(pricePer1000, quantity);

                // Obter informações do usuário
                const userInfo = await getUserInfo();
                if (!userInfo || !(userInfo.userId || userInfo.id || userInfo._id || userInfo.token)) {
                    throw new Error('Não foi possível obter informações do usuário');
                }

                // Detectar endpoint com base na rede do serviço
                const redeAttr = selectedOption.getAttribute('data-rede') || '';
                const apiEndpoint = getApiEndpointForRede(redeAttr);

                if (!apiEndpoint) {
                    throw new Error(`Rede desconhecida ou não suportada: "${redeAttr}". Contate o suporte.`);
                }

                // Preparar dados para a API
                const actionData = {
                    rede: redeAttr,
                    tipo: selectedOption.getAttribute('data-tipo'),
                    nome: selectedOption.textContent,
                    valor: totalValue,
                    quantidade: parseInt(quantity, 10),
                    link: link,
                    userId: userInfo.userId,
                    id_servico: serviceSelect.value
                };

                // Chamar API para criar ação no endpoint correto
                const result = await criarAcao(actionData, null, apiEndpoint);
                console.log("DEBUG RESULT CRIAR ACAO =>", JSON.stringify(result, null, 2));

                // Atualizar saldo
                if (result && typeof result.newSaldo !== 'undefined') {
                    const balanceElement = document.querySelector('.component-navbar-balance-item__navbar-private');
                    if (balanceElement) {
                        const formatted = new Intl.NumberFormat('pt-BR', {
                            style: 'currency',
                            currency: 'BRL'
                        }).format(result.newSaldo || 0);
                        balanceElement.textContent = formatted;
                    }
                } else {
                    await loadUserBalance();
                }

let idFinal = null;

// PRIORIDADE 1 — ID real da ação SMM
if (
    result.resultadosEnvio &&
    result.resultadosEnvio[0] &&
    result.resultadosEnvio[0].json &&
    result.resultadosEnvio[0].json.id_acao_smm
) {
    idFinal = result.resultadosEnvio[0].json.id_acao_smm;
}

// PRIORIDADE 2 — Caso API um dia retorne id_acao_smm direto
else if (result.id_acao_smm) {
    idFinal = result.id_acao_smm;
}

// PRIORIDADE 3 — fallback (id interno do sistema)
else if (result.pedidos && result.pedidos.length > 0) {
    idFinal = result.pedidos[0].id_pedido;
}

// Último recurso
else {
    idFinal = "N/D";
}
                // Exibir
                showNotification(`Pedido criado com sucesso! ID: ${idFinal}`, 'success');
                showSuccessMessage(`Pedido enviado com sucesso! ID: ${idFinal}`);

                // Limpar campos
                const chargeInput = document.getElementById('charge');
                if (chargeInput) chargeInput.value = '';

                const linkInputField = document.getElementById('orderform-link');
                if (linkInputField) linkInputField.value = '';

                // Chame a função:
                displaySuccessMessage(result);

            } catch (error) {
                console.error('Erro ao processar pedido:', error);
                showNotification(error.message || 'Erro ao processar pedido', 'danger');
            } finally {
                if (submitButton) {
                    submitButton.textContent = originalText;
                    submitButton.disabled = false;
                }
                document.body.classList.remove('loading');
            }
        }

        // Configurar event listener para o formulário
        document.addEventListener('DOMContentLoaded', function () {
            const orderForm = document.getElementById('order-form');
            if (orderForm) {
                orderForm.addEventListener('submit', handleFormSubmit);
            }

            // Reaplicar o posicionamento da mensagem quando a janela for redimensionada
            window.addEventListener('resize', function () {
                const existingMessage = document.getElementById('success-message');
                if (existingMessage) {
                    const messageText = existingMessage.textContent;
                    existingMessage.remove();
                    showSuccessMessage(messageText);
                }
            });
        });

        // Guarda serviços carregados globalmente para o search
        window._services = window._services || [];

        // Debounce helper
        function debounce(fn, wait = 180) {
            let t;
            return function (...args) {
                clearTimeout(t);
                t = setTimeout(() => fn.apply(this, args), wait);
            };
        }

        // Retorna emoji/ícone por rede/tipo simples
        function getIconForService(service) {
            const r = (service.rede || '').toLowerCase();
            const t = (service.tipo || '').toLowerCase();
            if (r.includes('instagram') || t.includes('instagram')) return '📷';
            if (r.includes('tiktok') || t.includes('tiktok')) return '🙎‍♂️';
            if (r.includes('youtube') || t.includes('youtube')) return '▶️';
            if (r.includes('facebook') || t.includes('facebook')) return '👥';
            return '🔧';
        }

        // Filtra serviços por termo (prioriza startsWith depois includes)
        function filterServicesBySearchTerm(term, services) {
            term = String(term || '').trim().toLowerCase();
            if (!term) return [];
            const starts = [];
            const contains = [];
            services.forEach(s => {
                const hay = `${s.nome || ''} ${s.descricao || ''} ${s.rede || ''} ${s.tipo || ''}`.toLowerCase();
                if (hay.startsWith(term)) starts.push(s);
                else if (hay.includes(term)) contains.push(s);
            });
            return starts.concat(contains);
        }

        // Renderiza a lista de resultados abaixo do input
        function renderSearchResults(results) {
            let container = document.getElementById('service-search-results');
            if (!container) {
                const searchInput = document.getElementById('template-input');
                container = document.createElement('div');
                container.id = 'service-search-results';
                if (searchInput && searchInput.parentNode) {
                    searchInput.parentNode.insertBefore(container, searchInput.nextSibling);
                } else {
                    document.body.appendChild(container);
                }
            }

            container.innerHTML = '';

            if (!results || results.length === 0) {
                const no = document.createElement('div');
                no.className = 'search-no-results';
                no.textContent = 'Nenhum serviço encontrado.';
                container.appendChild(no);
                return;
            }

            // limita resultados para evitar scroll gigantesco
            const max = 25;
            results.slice(0, max).forEach(service => {
                const item = document.createElement('div');
                item.className = 'service-result-item';
                item.tabIndex = 0;
                item.setAttribute('data-id', service.id_servico);

                const icon = document.createElement('div');
                icon.className = 'service-result-icon';
                icon.textContent = getIconForService(service);

                const body = document.createElement('div');
                body.className = 'service-result-body';

                const title = document.createElement('div');
                title.className = 'service-result-title';
                // Exemplo: "📷Seguidores Instagram (Menor Queda no momento)"
                title.textContent = service.nome;

                const sub = document.createElement('div');
                sub.className = 'service-result-sub';
                const noteParts = [];
                if (service.rede) noteParts.push(service.rede);
                if (service.tipo) noteParts.push(service.tipo);
                if (service.descricao) noteParts.push(String(service.descricao).slice(0, 80));
                sub.textContent = noteParts.join(' • ');

                body.appendChild(title);
                body.appendChild(sub);

                item.appendChild(icon);
                item.appendChild(body);

                // seleção: ao clicar seleciona o serviço no select e fecha a lista
                item.addEventListener('click', function () {
                    // tenta selecionar usando a função já existente selectServiceById
                    try {
                        selectServiceById(service.id_servico, window._services);
                    } catch (e) {
                        // fallback: seta value diretamente
                        const serviceSelect = document.getElementById('orderform-service');
                        if (serviceSelect) {
                            for (let i = 0; i < serviceSelect.options.length; i++) {
                                if (String(serviceSelect.options[i].value) === String(service.id_servico)) {
                                    serviceSelect.selectedIndex = i;
                                    serviceSelect.dispatchEvent(new Event('change'));
                                    break;
                                }
                            }
                        }
                    }
                    // esconde a lista
                    const container = document.getElementById('service-search-results');
                    if (container) container.innerHTML = '';
                });

                // keyboard support: Enter to select
                item.addEventListener('keydown', function (ev) {
                    if (ev.key === 'Enter') {
                        ev.preventDefault();
                        this.click();
                    }
                });

                container.appendChild(item);
            });
        }

        // Replace / enhance setupServiceEventListeners
        function setupServiceEventListeners(services) {
            // keep global copy for other functions
            window._services = services || window._services || [];

            const categorySelect = document.getElementById('orderform-category');
            const serviceSelect = document.getElementById('orderform-service');
            const searchInput = document.getElementById('template-input');
            const quantityInput = document.getElementById('orderform-quantity');

            if (categorySelect) {
                categorySelect.addEventListener('change', function () {
                    filterServicesByCategory(this.value, services);
                    // limpa resultados do search quando categoria muda
                    const sr = document.getElementById('service-search-results');
                    if (sr) sr.innerHTML = '';
                });
            }

            if (serviceSelect) {
                serviceSelect.addEventListener('change', handleServiceChange);
            }

            // cria container de resultados se não existir
            (function ensureResultContainer() {
                if (!document.getElementById('service-search-results')) {
                    const searchInputEl = document.getElementById('template-input');
                    if (searchInputEl) {
                        const container = document.createElement('div');
                        container.id = 'service-search-results';
                        searchInputEl.parentNode.insertBefore(container, searchInputEl.nextSibling);
                        container.innerHTML = '';
                    }
                }
            })();

            if (searchInput) {
                // comportamento: ao digitar, filtra e exibe sugestões
                const onInput = debounce(function () {
                    const term = this.value || '';
                    if (!term.trim()) {
                        // vazio — esconde resultados e restaura options visíveis
                        const sr = document.getElementById('service-search-results');
                        if (sr) sr.innerHTML = '';
                        // also restore option display if you used the previous option hide approach
                        const serviceSelect = document.getElementById('orderform-service');
                        if (serviceSelect) {
                            Array.from(serviceSelect.options).forEach(opt => opt.style.display = '');
                        }
                        return;
                    }
                    const filtered = filterServicesBySearchTerm(term, window._services || []);
                    renderSearchResults(filtered);
                    // opcional: highlight matched options in select (keeps accessibility)
                    const serviceSelectEl = document.getElementById('orderform-service');
                    if (serviceSelectEl) {
                        Array.from(serviceSelectEl.options).forEach(opt => {
                            const hay = opt.textContent.toLowerCase();
                            opt.style.display = hay.includes(term.toLowerCase()) ? '' : 'none';
                        });
                    }
                }, 160);

                searchInput.addEventListener('input', onInput);

                // limpar resultados quando input perde foco (com pequeno delay para clique funcionar)
                searchInput.addEventListener('blur', function () {
                    setTimeout(() => {
                        const sr = document.getElementById('service-search-results');
                        if (sr) sr.innerHTML = '';
                    }, 180);
                });

                // se o usuário clicar no campo, mostra sugestões rápidas baseadas no valor atual
                searchInput.addEventListener('focus', function () {
                    const term = this.value || '';
                    if (term.trim()) {
                        const filtered = filterServicesBySearchTerm(term, window._services || []);
                        renderSearchResults(filtered);
                    }
                });
            }

            if (quantityInput) {
                quantityInput.addEventListener('input', handleQuantityChange);
            }
        }

    </script>
    <link rel="stylesheet" type="text/css" href="https://storage.perfectcdn.com/global/tad3g2kcwfrtr6yi.css">
    <link rel="stylesheet" type="text/css" href="https://storage.perfectcdn.com/ahnerj/2pcamz1sqmak1hf9.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script>
        window.modules = {};
    </script>
</head>

<body class="body  body-internal">
    <div class="wrapper  wrapper-sidebar-navbar ">
        <div id="block_52" class="component_private_navbar">
            <span class="component_private_navbar ">
                <div class="component_private_navbar__wrapper component_private_sidebar ">
                    <div
                        class="sidebar-block__top component-navbar component-navbar__navbar-private editor__component-wrapper ">
                        <div>
                            <nav class="navbar navbar-expand-lg navbar-light">
                                <div class="navbar-private__header">
                                    <div class="sidebar-block__top-brand">
                                        <a href="/painel.html"
                                            class="component-navbar-brand component-navbar-public-brand">
                                            <h3><strong style="font-weight: bold"></strong><span
                                                    style="color: var(--color-id-117)"><strong
                                                        style="font-weight: bold">SMM SOCIAIS</strong></span></h3>
                                        </a>
                                    </div>
                                    <button class="navbar-toggler" type="button" data-toggle="collapse"
                                        data-target="#navbar-collapse-52" aria-controls="navbar-collapse-52"
                                        aria-expanded="false" aria-label="Toggle navigation">
                                        <span class="navbar-burger">
                                            <span class="navbar-burger-line"></span>
                                        </span>
                                    </button>
                                </div>
                                <div class="collapse navbar-collapse" id="navbar-collapse-52">
                                    <div class="component-navbar-collapse-divider"></div>
                                    <div class="d-flex component-navbar-collapse">
                                        <ul class="navbar-nav navbar-nav-sidebar-menu">
                                            <li
                                                class="nav-item component-navbar-nav-item component-navbar-private-nav-item">
                                                <a class="component-navbar-nav-link  component-navbar-nav-link__navbar-private component-navbar-nav-link-active__navbar-private"
                                                    href="/painel">
                                                    Novo Pedido
                                                </a>
                                            </li>
                                            <li
                                                class="nav-item component-navbar-nav-item component-navbar-private-nav-item">
                                                <a class="component-navbar-nav-link  component-navbar-nav-link__navbar-private "
                                                    href="/services">
                                                    Serviços
                                                </a>
                                            </li>
                                            <li
                                                class="nav-item component-navbar-nav-item component-navbar-private-nav-item">
                                                <a class="component-navbar-nav-link  component-navbar-nav-link__navbar-private "
                                                    href="/orders">
                                                    Ordens
                                                </a>
                                            </li>
                                            <li
                                                class="nav-item component-navbar-nav-item component-navbar-private-nav-item">
                                                <a class="component-navbar-nav-link  component-navbar-nav-link__navbar-private "
                                                    href="/addfunds">
                                                    Adicionar Saldo
                                                </a>
                                            </li>
                                            <li
                                                class="nav-item component-navbar-nav-item component-navbar-private-nav-item">
                                                <a class="component-navbar-nav-link  component-navbar-nav-link__navbar-private "
                                                    href="/affiliates">
                                                    Meus Indicados
                                                </a>
                                            </li>
                                            <li
                                                class="nav-item component-navbar-nav-item component-navbar-private-nav-item">
                                                <a class="component-navbar-nav-link  component-navbar-nav-link__navbar-private "
                                                    href="/massorder">
                                                    Pedido em Massa
                                                </a>
                                            </li>
                                        </ul>
                                        <ul class="navbar-nav navbar-nav-currencies">
                                            <li
                                                class="nav-item d-flex align-items-center component-navbar-nav-item component-navbar-private-nav-item component-navbar-balance-wrap__navbar-private">
                                                <a class="component-navbar-balance-item__navbar-private">R$ 0,00</a>
                                            </li>
                                        </ul>
                                        <ul class="navbar-nav">
                                            <li
                                                class="nav-item component-navbar-nav-item component-navbar-private-nav-item">
                                                <a class="component-navbar-nav-link  component-navbar-nav-link__navbar-private"
                                                    href="/account">Conta</a>
                                            </li>
                                            <li
                                                class="nav-item component-navbar-nav-item component-navbar-private-nav-item">
                                                <a class="component-navbar-nav-link  component-navbar-nav-link__navbar-private"
                                                    href="/">Sair</a>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </nav>
                        </div>
                    </div>
                </div>
            </span>
            <span class="component_private_sidebar ">
                <div class="component-sidebar_wrapper">
                    <div
                        class="sidebar-block__left component-sidebar component-sidebar-with-navbar component_private_navbar editor__component-wrapper">
                        <div class="component-sidebar__menu">
                            <div class="component-sidebar__menu-logo">
                                <a href="/painel" class="component-navbar-brand component-sidebar__menu-brand">
                                    <h3><strong style="font-weight: bold">SMM </strong><span
                                            style="font-weight: bold">SOCIAIS</strong></span></h3>
                                </a>
                            </div>
                            <ul class="sidebar-block__left-menu editor__component-wrapper">
                                <li class="component-sidebar__menu-item component-sidebar__menu-item-active">
                                    <a class="component-sidebar__menu-item-link" href="/painel">
                                        Novo Pedido
                                    </a>
                                </li>
                                <li class="component-sidebar__menu-item ">
                                    <a class="component-sidebar__menu-item-link" href="/services">
                                        Serviços
                                    </a>
                                </li>
                                <li class="component-sidebar__menu-item ">
                                    <a class="component-sidebar__menu-item-link" href="/orders">
                                        Ordens
                                    </a>
                                </li>
                                <li class="component-sidebar__menu-item ">
                                    <a class="component-sidebar__menu-item-link" href="/addfunds">
                                        Adicionar Saldo
                                    </a>
                                </li>
                                <li class="component-sidebar__menu-item ">
                                    <a class="component-sidebar__menu-item-link" href="/affiliates">
                                        Meus Indicados
                                    </a>
                                </li>
                                <li class="component-sidebar__menu-item ">
                                    <a class="component-sidebar__menu-item-link" href="/massorder">
                                        Pedido em Massa
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </span>
        </div>
        <div class="wrapper-content">
            <div class="wrapper-content__header">
            </div>
            <div class="wrapper-content__body">
                <!-- Main variables *content* -->
                <div id="block_60">
                    <div class="block-bg"></div>
                    <div class="container-fluid">
                        <div class="new_order-block ">
                            <div class="row">
                                <div class="col-lg-7 mb-3 mb-lg-0">
                                    <div
                                        class="component_form_group component_card component_radio_button component_platforms">
                                        <div class="card ">
                                            <form action="/" method="post" id="order-form">
                                                <div class="component_button_forms">
                                                    <div class="form-group">
                                                        <div class="search-dropdown" id="new-order-search"
                                                            style="position: relative;"
                                                            data-lang-placeholder="Procurar">
                                                            <div class="input-wrapper" style="position: relative;">
                                                                <i class="fas fa-search" style="position: absolute;
                  top: 50%;
                  left: 15px;
                  transform: translateY(-50%);
                  color: #666;
                  z-index: 2;"></i>
                                                                <input type="text" class="form-control"
                                                                    id="template-input" value="" placeholder="Procurar"
                                                                    style="padding-left: 40px;">
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="form-group">
                                                        <label for="orderform-category"
                                                            class="control-label">Categoria</label>
                                                        <!-- DEPOIS: -->
                                                        <select class="form-control" id="orderform-category"
                                                            name="OrderForm[category]">
                                                            <!-- Categorias serão preenchidas dinamicamente -->
                                                        </select>
                                                        </option>
                                                        <!-- Categorias serão preenchidas dinamicamente -->
                                                        </select>
                                                        <div id="select-category-container" class="position-relative">
                                                        </div>
                                                    </div>
                                                    <div class="form-group">
                                                        <label for="orderform-service"
                                                            class="control-label">Serviço</label>
                                                        <div class="d-flex">
                                                            <div class="w-100 new_order-block__services-list">
                                                                <select class="form-control" id="orderform-service"
                                                                    name="OrderForm[service]" data-select="true"
                                                                    data-select-search="true"
                                                                    data-select-search-placeholder="Procurar"
                                                                    data-select-container="#select-service-container">
                                                                    <option value="" selected>Carregando serviços...
                                                                    </option>
                                                                </select>
                                                                <div id="select-service-container"
                                                                    class="position-relative"></div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="form-group hidden fields component_service_description"
                                                        id="service_description">
                                                        <label for="service_description"
                                                            class="control-label">Descrição</label>
                                                        <div class="panel-description">

                                                        </div>
                                                    </div>
                                                    <!-- Campos adicionados: Link e Quantidade -->
                                                    <div class="form-group hidden" id="link_field">
                                                        <label for="orderform-link" class="control-label">Link</label>
                                                        <input type="text" class="form-control" id="orderform-link"
                                                            name="OrderForm[link]" placeholder="Cole o link aqui">
                                                    </div>
                                                    <div class="form-group hidden" id="quantity_field">
                                                        <label for="orderform-quantity"
                                                            class="control-label">Quantidade</label>
                                                        <input type="number" class="form-control"
                                                            id="orderform-quantity" name="OrderForm[quantity]"
                                                            placeholder="Digite a quantidade" min="0">
                                                    </div>
                                                    <div id="fields"></div>
                                                    <div class="form-group">
                                                        <label for="charge" class="control-label">Valor</label>
                                                        <input type="text" class="form-control" id="charge" value=""
                                                            readonly>
                                                    </div>
                                                </div>
                                                <input type="hidden" name="_csrf"
                                                    value="Xbole38fGiDW4C4919TBihZOb3zsg6y7CdYCRlPW1hAqzX0tNW9zTe-SenyHhY7HIQEeG8Ht3NZ8gnURPbHmRg==">
                                                <div class="new-order-button-submit component_button_submit ">
                                                    <button type="submit"
                                                        class="btn btn-block btn-big-primary">Enviar</button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-5">
                                    <div class="component_content_card component_content_button">
                                        <div class="card">
                                            <div class="new-order__content-title">
                                                <div class="position-relative">
                                                    <p>Para usar nossos serviços clique em <a target="_self"
                                                            href="/addfunds">"Adicionar saldo"</a> ou <a target="_self"
                                                            href="/addfunds">aqui</a></p>
                                                    <p><br></p>
                                                    <p><br></p>
                                                    <p>Aceitamos somente <a target="_self" href="/addfunds">Pix</a> <a
                                                            target="_self" href="/addfunds">- clique aqui para
                                                            recarregar o &nbsp;seu saldo - </a>(Tudo integrado de forma
                                                        automática, ou seja, você faz o Pix e ele entra no seu saldo na
                                                        mesma hora! Se atente a usar a opção "Pix copia e cola"</p>
                                                    <p>Caso você NÃO saiba utilizar a opção "Copia e cola" do Pix, <a
                                                            target="_blank"
                                                            href="https://www.youtube.com/watch?v=YIenNQLvb9g">clique
                                                            aqui</a></p>
                                                    <p><br></p>
                                                    <p>Estamos dando 10% de comissão para todas as compras que seus
                                                        amigos fizerem tendo se cadastrado no seu link! Para entender
                                                        melhor <a target="_self" href="/affiliates">clique aqui</a></p>
                                                </div>
                                            </div>
                                            <div class="new-order__content-text">
                                                <p>Somos uma empresa de publicidade digital, com diversos serviços à sua
                                                    disposição para alavancar seu perfil nas redes sociais,
                                                    proporcionando novas oportunidades para você ou sua empresa!&nbsp;
                                                </p>
                                                <p>Suporte das 6:30 até às 22 horas de segunda-feira a sexta-feira</p>
                                                <p><br></p>
                                                <h1>CONTATO</h1>
                                                <p><br></p>
                                                <p><br></p>
                                                <p><strong style="font-weight: bold">E-mail</strong>:
                                                    contato@smmsociais.com</p>
                                                <p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Nosso Instagram é <a target="_blank"
                                                        href="https://www.instagram.com/smmsociais/">@smmsociais</a>
                                                    &nbsp;</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>
    </div>
    </div>

    </a>
    </div>
    </div>
    </div>
    </div>
    </div>
    </div>
    </div>
    </div>
    <div class="wrapper-content__footer">
    </div>
    </div>
    </div>
    <!-- Notifications wrapper -->
    <div id="notify-wrapper" class="alert alert-success mb-3 hidden" style="display: none;"></div>

    <!-- ======= Navbar toggle fallback (vanilla JS) - torna o "hamburger" funcional em dispositivos móveis ======= -->
    <script>
        (function () {
            // Função utilitária para encontrar o alvo do botão (data-target ou aria-controls)
            function resolveTarget(button) {
                const targetSelector = button.getAttribute('data-target') || button.getAttribute('data-bs-target') || ('#' + (button.getAttribute('aria-controls') || ''));
                if (!targetSelector) return null;
                try {
                    return document.querySelector(targetSelector);
                } catch (e) {
                    return null;
                }
            }

            // Inicializa todos os togglers de navbar existentes
            function initNavTogglers() {
                const togglers = document.querySelectorAll('.navbar-toggler');
                togglers.forEach(btn => {
                    const target = resolveTarget(btn);
                    if (!target) return;

                    // Garantir que o botão tenha type="button" para evitar submit acidental
                    if (!btn.hasAttribute('type')) btn.setAttribute('type', 'button');

                    // Evitar duplicar event listeners
                    if (btn.__nav_init) return;
                    btn.__nav_init = true;

                    btn.addEventListener('click', function (e) {
                        e.preventDefault();
                        const isShown = target.classList.contains('show');
                        if (isShown) {
                            target.classList.remove('show');
                            btn.classList.remove('collapsed');
                            btn.setAttribute('aria-expanded', 'false');
                        } else {
                            target.classList.add('show');
                            btn.classList.add('collapsed');
                            btn.setAttribute('aria-expanded', 'true');
                        }
                    });

                    // Fechar ao clicar fora (somente se estiver aberto)
                    document.addEventListener('click', function (ev) {
                        if (!target.classList.contains('show')) return;
                        if (btn.contains(ev.target) || target.contains(ev.target)) return;
                        target.classList.remove('show');
                        btn.setAttribute('aria-expanded', 'false');
                    });

                    // Fechar ao pressionar ESC
                    document.addEventListener('keydown', function (ev) {
                        if (ev.key === 'Escape' && target.classList.contains('show')) {
                            target.classList.remove('show');
                            btn.setAttribute('aria-expanded', 'false');
                        }
                    });

                    // Ao redimensionar para telas grandes, garantir menu fechado
                    window.addEventListener('resize', function () {
                        if (window.innerWidth >= 992 && target.classList.contains('show')) {
                            target.classList.remove('show');
                            btn.setAttribute('aria-expanded', 'false');
                        }
                    });
                });
            }

            // Inicializar no DOM ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initNavTogglers);
            } else {
                initNavTogglers();
            }
        })();
    </script>

    <!-- Script para garantir que a página apareça apenas após todas as APIs terminarem -->
    <script>
        (function () {
            // mostra um overlay loader enquanto aguarda
            const loader = document.createElement('div');
            loader.id = 'page-loader';
            loader.innerHTML = `
                <div style="text-align:center">
                    <div class="spinner-border" role="status" aria-hidden="true"></div>
                    <div style="margin-top:8px">Carregando dados...</div>
                </div>`;
            document.body.appendChild(loader);

            // --- opcional: esperar window.load para garantir recursos externos carregados ---
            const windowLoadPromise = new Promise(resolve => {
                if (document.readyState === 'complete') return resolve();
                window.addEventListener('load', resolve);
            });

            // Executar fillAndHideInput imediatamente (não depende de APIs)
            fillAndHideInput();

            // --- Promise principal: saldo + serviços (+ window.load) ---
            const saldoPromise = loadUserBalance();
            const servicesPromise = loadServices();

            Promise.all([saldoPromise, servicesPromise, windowLoadPromise])
                .then(() => {
                    document.body.classList.add('loaded');

                    // Inicializar campos com valores padrão após um pequeno delay
                    // para garantir que o DOM esteja completamente renderizado
                    setTimeout(() => {
                        initializeDefaultFields();
                    }, 100);
                })
                .catch(err => {
                    // se algo muito inesperado acontecer, logamos e mostramos a página (UX)
                    console.error('Erro ao carregar dados principais:', err);
                    document.body.classList.add('loaded');
                    const serviceSelect = document.getElementById('orderform-service');
                    if (serviceSelect && serviceSelect.innerHTML.includes('Carregando serviços')) {
                        serviceSelect.innerHTML = '<option value="">Erro ao carregar serviços</option>';
                    }
                })
                .finally(() => {
                    // remover loader visual
                    if (loader && loader.parentNode) loader.parentNode.removeChild(loader);
                });

            // Segurança extra: fallback para evitar tela eternamente oculta (ex.: bloqueio de CORS extremo)
            setTimeout(() => {
                if (!document.body.classList.contains('loaded')) {
                    console.warn('Fallback: exibindo página após timeout.');
                    document.body.classList.add('loaded');
                    if (loader && loader.parentNode) loader.parentNode.removeChild(loader);
                }
            }, 15000); // 15s — opcional, ajuste conforme necessidade
        })();
    </script>

    <!-- Botão do WhatsApp para suporte -->
    <a href="https://wa.me/5582999801112?text=Olá,%20preciso%20de%20ajuda" target="_blank" id="whatsapp-button">
        <img src="https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/whatsapp.svg" alt="WhatsApp">
    </a>
</body>

</html>
