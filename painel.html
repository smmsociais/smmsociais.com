<!DOCTYPE html>
<html id="theme_23" lang="pt-BR">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>New order</title>
    <style>
        /* Initial Load */
        body {
            visibility: hidden;
            opacity: 0;
            transition: opacity 240ms ease;
        }

        body.loaded {
            visibility: visible;
            opacity: 1;
        }

        #page-loader {
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.9);
            z-index: 9999;
        }

        .hidden {
            display: none !important;
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .alert {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            min-width: 300px;
        }

        /* Estilo para a mensagem de sucesso */
        .success-message {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 12px 20px;
            border-radius: 4px;
            margin-top: 20px;
            text-align: center;
        }

        /* Ajustes para dispositivos pequenos */
        @media (max-width: 991.98px) {
            .success-message-mobile {
                margin: 20px 0;
                order: 1;
            }

            .new_order-block .row {
                display: flex;
                flex-direction: column;
            }

            .new_order-block .col-lg-7 {
                order: 2;
            }

            .new_order-block .col-lg-5 {
                order: 3;
            }
        }
    </style>
    <script>
        // Função para obter parâmetros da URL
        function getUrlParams() {
            const params = new URLSearchParams(window.location.search);
            const paramsObj = {};
            for (const [key, value] of params) {
                paramsObj[key] = value;
            }
            return paramsObj;
        }

        // Função para obter o token do localStorage
        function loadToken() {
            const token = localStorage.getItem('authToken') ||
                localStorage.getItem('token') ||
                localStorage.getItem('user_token') ||
                localStorage.getItem('auth') ||
                getToken();
            return token;
        }

        // Função para carregar saldo do usuário
        async function loadUserBalance() {
            const token = loadToken();

            if (!token) {
                console.error("Token não encontrado.");
                // Definir saldo como R$ 0,00 em caso de erro
                const balanceElement = document.querySelector('.component-navbar-balance-item__navbar-private');
                if (balanceElement) {
                    balanceElement.textContent = 'R$ 0,00';
                }
                return 0;
            }

            try {
                const response = await fetch('https://smmsociais.com/api/get_saldo', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error('Erro ao carregar saldo');
                }

                const balanceData = await response.json();

                // Formatar o saldo como moeda brasileira
                const formattedBalance = new Intl.NumberFormat('pt-BR', {
                    style: 'currency',
                    currency: 'BRL'
                }).format(balanceData.saldo || 0);

                // Atualizar o saldo na navbar
                const balanceElement = document.querySelector('.component-navbar-balance-item__navbar-private');
                if (balanceElement) {
                    balanceElement.textContent = formattedBalance;
                }

                return balanceData.saldo;

            } catch (error) {
                console.error('Erro ao carregar saldo:', error);
                // Definir saldo como R$ 0,00 em caso de erro
                const balanceElement = document.querySelector('.component-navbar-balance-item__navbar-private');
                if (balanceElement) {
                    balanceElement.textContent = 'R$ 0,00';
                }
                return 0;
            }
        }

        // Função para obter informações do usuário
        async function getUserInfo() {
            const token = loadToken();

            if (!token) {
                console.error("Token não encontrado.");
                return null;
            }

            try {
                const response = await fetch('https://smmsociais.com/api/account', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    // mostra o status e corpo para debug
                    const txt = await response.text().catch(() => null);
                    console.error('Erro ao carregar informações do usuário. status:', response.status, txt);
                    throw new Error('Erro ao carregar informações do usuário');
                }

                const userData = await response.json();
                console.log('getUserInfo response:', userData);

                // Normaliza campos esperados
                const normalized = {
                    userId: userData.userId || userData.id || userData._id || null,
                    nome_usuario: userData.nome_usuario || userData.nome || null,
                    email: userData.email || null,
                    token: userData.token || token
                };

                return normalized;
            } catch (error) {
                console.error('Erro ao carregar informações do usuário:', error);
                return null;
            }
        }

        function generateRandomNumber() {
            return Math.floor(Math.random() * 90000) + 10000;
        }

        function hideInputAndDiv() {
            var input = document.getElementById('field-cpf_cnpj');
            var div = document.getElementById('order_cpf_cnpj');

            if (input) {
                input.style.display = 'none';
            }

            if (div) {
                div.style.display = 'none';
            }
        }

        function fillAndHideInput() {
            var input = document.getElementById('field-cpf_cnpj');
            if (input) {
                var randomNumber = generateRandomNumber();
                input.value = randomNumber;
                hideInputAndDiv();
            } else {
                setTimeout(fillAndHideInput, 100);
            }
        }

        // Função para carregar serviços da API
        function loadServices() {
            return fetch('https://smmsociais.com/api/servico')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Erro ao carregar serviços da API');
                    }
                    return response.json();
                })
                .then(services => {
                    renderServices(services);
                    return services;
                })
                .catch(error => {
                    console.error('Erro ao carregar serviços:', error);
                    const serviceSelect = document.getElementById('orderform-service');
                    if (serviceSelect) {
                        serviceSelect.innerHTML = '<option value="">Erro ao carregar serviços</option>';
                    }
                    return [];
                });
        }

        // Função para renderizar serviços no formulário
        function renderServices(services) {
            const serviceSelect = document.getElementById('orderform-service');
            if (!serviceSelect) return;

            // Limpar opções existentes
            serviceSelect.innerHTML = '';

            // Adicionar opção padrão
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'Selecione um serviço';
            serviceSelect.appendChild(defaultOption);

            // Adicionar serviços da API
            services.forEach(service => {
                const option = document.createElement('option');
                option.value = service.id_servico;
                option.textContent = service.nome;
                option.setAttribute('data-price', service.preco_1000);
                option.setAttribute('data-min', service.minimo);
                option.setAttribute('data-max', service.maximo);
                option.setAttribute('data-description', service.descricao);
                option.setAttribute('data-rede', service.rede);
                option.setAttribute('data-tipo', service.tipo);
                serviceSelect.appendChild(option);
            });

            // Verificar se há um serviço específico na URL
            const urlParams = getUrlParams();
            const serviceIdFromUrl = urlParams.service;

            if (serviceIdFromUrl) {
                // Tentar selecionar o serviço da URL
                selectServiceById(serviceIdFromUrl, services);
            } else {
                // Preencher automaticamente com o primeiro serviço se não houver parâmetro
                if (services.length > 0) {
                    autoSelectFirstService(services);
                }
            }

            // Atualizar categorias com base nos serviços
            updateCategories(services);

            // Configurar event listeners
            setupServiceEventListeners(services);
        }

        // Função para selecionar serviço por ID
        function selectServiceById(serviceId, services) {
            const serviceSelect = document.getElementById('orderform-service');
            if (!serviceSelect) return;

            // Encontrar o serviço pelo ID
            const service = services.find(s => s.id_servico == serviceId);

            if (service) {
                // Encontrar a opção correspondente no select
                for (let i = 0; i < serviceSelect.options.length; i++) {
                    if (serviceSelect.options[i].value == serviceId) {
                        serviceSelect.selectedIndex = i;

                        // Disparar o evento change para atualizar todos os campos
                        const event = new Event('change');
                        serviceSelect.dispatchEvent(event);

                        // Garantir que os campos sejam exibidos
                        showServiceFields();

                        console.log(`Serviço selecionado automaticamente: ${service.nome} (ID: ${serviceId})`);
                        return;
                    }
                }
            }

            // Se não encontrou o serviço, usar o primeiro disponível
            console.warn(`Serviço com ID ${serviceId} não encontrado. Selecionando primeiro serviço disponível.`);
            if (services.length > 0) {
                autoSelectFirstService(services);
            }
        }

        // Função para preencher automaticamente o primeiro serviço
        function autoSelectFirstService(services) {
            const serviceSelect = document.getElementById('orderform-service');
            if (serviceSelect && serviceSelect.options.length > 1) {
                // Selecionar o primeiro serviço (índice 1, pois o índice 0 é a opção padrão)
                serviceSelect.selectedIndex = 1;

                // Disparar o evento change para atualizar todos os campos
                const event = new Event('change');
                serviceSelect.dispatchEvent(event);

                // Garantir que os campos sejam exibidos
                showServiceFields();
            }
        }

        // Função para mostrar campos do serviço
        function showServiceFields() {
            const linkField = document.getElementById('link_field');
            const quantityField = document.getElementById('quantity_field');
            const serviceDescription = document.getElementById('service_description');

            if (linkField) linkField.classList.remove('hidden');
            if (quantityField) quantityField.classList.remove('hidden');
            if (serviceDescription) serviceDescription.classList.remove('hidden');
        }

        // Função para atualizar categorias com base nos serviços
        function updateCategories(services) {
            const categorySelect = document.getElementById('orderform-category');
            if (!categorySelect) return;

            // Limpar categorias existentes, mantendo apenas a opção padrão
            while (categorySelect.options.length > 1) {
                categorySelect.remove(1);
            }

            const categories = new Set();

            // Coletar categorias únicas
            services.forEach(service => {
                if (service.categoria) {
                    categories.add(service.categoria);
                }
            });

            // Adicionar categorias ao dropdown
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                categorySelect.appendChild(option);
            });

            // Selecionar automaticamente a primeira categoria
            if (categories.size > 0) {
                autoSelectFirstCategory(categories);
            }
        }

        // Função para selecionar automaticamente a primeira categoria
        function autoSelectFirstCategory(categories) {
            const categorySelect = document.getElementById('orderform-category');
            if (categorySelect && categorySelect.options.length > 1) {
                // Pular a primeira opção (índice 0) que é "Favorite services"
                // e selecionar a primeira categoria real (índice 1)
                categorySelect.selectedIndex = 1;

                // Disparar o evento change para filtrar os serviços
                const event = new Event('change');
                categorySelect.dispatchEvent(event);
            }
        }

        // Função para configurar event listeners dos serviços
        function setupServiceEventListeners(services) {
            const categorySelect = document.getElementById('orderform-category');
            const serviceSelect = document.getElementById('orderform-service');
            const searchInput = document.getElementById('template-input');
            const quantityInput = document.getElementById('orderform-quantity');

            if (categorySelect) {
                categorySelect.addEventListener('change', function () {
                    filterServicesByCategory(this.value, services);
                });
            }

            if (serviceSelect) {
                serviceSelect.addEventListener('change', handleServiceChange);
            }

            if (searchInput) {
                searchInput.addEventListener('input', function () {
                    const searchTerm = this.value.toLowerCase();
                    const serviceSelect = document.getElementById('orderform-service');
                    const options = serviceSelect.querySelectorAll('option');

                    options.forEach(option => {
                        const text = option.textContent.toLowerCase();
                        if (text.includes(searchTerm) || option.value === '') {
                            option.style.display = '';
                        } else {
                            option.style.display = 'none';
                        }
                    });
                });
            }

            if (quantityInput) {
                quantityInput.addEventListener('input', handleQuantityChange);
            }
        }

        // Função para filtrar serviços por categoria
        function filterServicesByCategory(category, services) {
            const serviceSelect = document.getElementById('orderform-service');
            if (!serviceSelect) return;

            // Limpar opções existentes
            serviceSelect.innerHTML = '';

            // Adicionar opção padrão
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = category === '-1' ? 'Todos os serviços' : 'Selecione um serviço';
            serviceSelect.appendChild(defaultOption);

            // Filtrar e adicionar serviços
            const filteredServices = category === '-1'
                ? services
                : services.filter(service => service.categoria === category);

            filteredServices.forEach(service => {
                const option = document.createElement('option');
                option.value = service.id_servico;
                option.textContent = service.nome;
                option.setAttribute('data-price', service.preco_1000);
                option.setAttribute('data-min', service.minimo);
                option.setAttribute('data-max', service.maximo);
                option.setAttribute('data-description', service.descricao);
                option.setAttribute('data-rede', service.rede);
                option.setAttribute('data-tipo', service.tipo);
                serviceSelect.appendChild(option);
            });

            // Verificar se há um serviço específico na URL após o filtro
            const urlParams = getUrlParams();
            const serviceIdFromUrl = urlParams.service;

            if (serviceIdFromUrl) {
                // Tentar selecionar o serviço da URL mesmo após o filtro
                const serviceExists = filteredServices.some(s => s.id_servico == serviceIdFromUrl);
                if (serviceExists) {
                    selectServiceById(serviceIdFromUrl, filteredServices);
                } else if (filteredServices.length > 0) {
                    // Se o serviço da URL não está na categoria filtrada, usar o primeiro disponível
                    autoSelectFirstService(filteredServices);
                }
            } else if (filteredServices.length > 0) {
                // Preencher automaticamente com o primeiro serviço após filtro
                autoSelectFirstService(filteredServices);
            }
        }

        // Função para lidar com mudança de serviço
        function handleServiceChange() {
            const selectedOption = this.options[this.selectedIndex];
            const price = selectedOption.getAttribute('data-price');
            const description = selectedOption.getAttribute('data-description');
            const minQuantity = selectedOption.getAttribute('data-min');
            const maxQuantity = selectedOption.getAttribute('data-max');

            // Atualizar preço
            const quantityInput = document.getElementById('orderform-quantity');
            const currentQuantity = quantityInput ? quantityInput.value || minQuantity || 0 : 0;
            updateChargeField(price, currentQuantity);

            // Atualizar descrição
            const descriptionPanel = document.querySelector('.panel-description');
            if (description && descriptionPanel) {
                descriptionPanel.innerHTML = description.replace(/\n/g, '<br>');
                const serviceDescription = document.getElementById('service_description');
                if (serviceDescription) {
                    serviceDescription.classList.remove('hidden');
                }
            } else if (descriptionPanel) {
                descriptionPanel.innerHTML = '';
                const serviceDescription = document.getElementById('service_description');
                if (serviceDescription) {
                    serviceDescription.classList.add('hidden');
                }
            }

            // Mostrar/ocultar campos de link e quantidade
            const linkField = document.getElementById('link_field');
            const quantityField = document.getElementById('quantity_field');

            if (selectedOption.value) {
                if (linkField) linkField.classList.remove('hidden');
                if (quantityField) quantityField.classList.remove('hidden');

                // Configurar limites da quantidade
                if (quantityInput) {
                    if (minQuantity) {
                        quantityInput.min = minQuantity;
                        quantityInput.placeholder = `Mínimo: ${minQuantity}`;
                    }
                    if (maxQuantity) {
                        quantityInput.max = maxQuantity;
                        quantityInput.placeholder = `Mínimo: ${minQuantity || 0}, Máximo: ${maxQuantity}`;
                    }

                    // Preencher quantidade mínima automaticamente
                    if (minQuantity && !quantityInput.value) {
                        quantityInput.value = minQuantity;
                        updateChargeField(price, minQuantity);
                    }
                }
            } else {
                if (linkField) linkField.classList.add('hidden');
                if (quantityField) quantityField.classList.add('hidden');
            }
        }

        // Função para lidar com mudança de quantidade
        function handleQuantityChange() {
            const serviceSelect = document.getElementById('orderform-service');
            if (!serviceSelect) return;

            const selectedOption = serviceSelect.options[serviceSelect.selectedIndex];
            const price = selectedOption ? selectedOption.getAttribute('data-price') : null;

            if (price) {
                updateChargeField(price, this.value);
            }
        }

        // --- Calcular total (robusto) ---
        function calculateTotal(pricePer1000, quantity) {
            const price = parseFloat(pricePer1000);
            const qty = parseInt(String(quantity).replace(/[^\d]/g, ''), 10);

            if (isNaN(price) || isNaN(qty) || qty <= 0) return 0;
            return (price * qty) / 1000;
        }

        function updateChargeField(pricePer1000, quantity) {
            const chargeInput = document.getElementById('charge');
            if (!chargeInput) return;

            const qty = parseInt(String(quantity).replace(/[^\d]/g, ''), 10);

            if (pricePer1000 && !isNaN(qty) && qty > 0) {
                const total = calculateTotal(pricePer1000, qty);
                chargeInput.value = `R$ ${total.toFixed(2)} (R$ ${parseFloat(pricePer1000).toFixed(2)} por 1000)`;
            } else if (pricePer1000) {
                chargeInput.value = `R$ ${parseFloat(pricePer1000).toFixed(2)} por 1000`;
            } else {
                chargeInput.value = '';
            }
        }

        // Função para inicializar todos os campos com valores padrão
        function initializeDefaultFields() {
            const serviceSelect = document.getElementById('orderform-service');
            if (serviceSelect && serviceSelect.selectedIndex > 0) {
                // Garantir que os campos estejam visíveis
                showServiceFields();

                // Disparar evento change para preencher todos os campos
                const event = new Event('change');
                serviceSelect.dispatchEvent(event);
            }
        }

        // Função para mostrar notificação
        function showNotification(message, type = 'success') {
            const notifyWrapper = document.getElementById('notify-wrapper');
            if (!notifyWrapper) return;

            notifyWrapper.textContent = message;
            notifyWrapper.className = `alert alert-${type} mb-3`;
            notifyWrapper.style.display = 'block';

            setTimeout(() => {
                notifyWrapper.style.display = 'none';
            }, 5000);
        }

        // Função para mostrar mensagem de sucesso abaixo do container dos serviços
        function showSuccessMessage(message) {
            // Remover mensagem anterior se existir
            const existingMessage = document.getElementById('success-message');
            if (existingMessage) {
                existingMessage.remove();
            }

            // Criar nova mensagem
            const successMessage = document.createElement('div');
            successMessage.id = 'success-message';
            successMessage.className = 'success-message';

            // Adicionar classe específica para mobile
            if (window.innerWidth < 992) {
                successMessage.classList.add('success-message-mobile');
            }

            successMessage.textContent = message;

            // Inserir no local correto baseado no tamanho da tela
            if (window.innerWidth < 992) {
                // Em dispositivos pequenos: inserir entre os containers
                const servicesContainer = document.querySelector('.new_order-block .col-lg-7');
                const contactContainer = document.querySelector('.new_order-block .col-lg-5');
                const rowContainer = document.querySelector('.new_order-block .row');

                if (rowContainer && servicesContainer && contactContainer) {
                    // Remover a mensagem existente primeiro
                    const existingMsg = document.getElementById('success-message');
                    if (existingMsg) existingMsg.remove();

                    // Criar uma nova linha para a mensagem
                    const messageRow = document.createElement('div');
                    messageRow.className = 'col-12';
                    messageRow.appendChild(successMessage);

                    // Inserir após o container de serviços e antes do container de contato
                    rowContainer.insertBefore(messageRow, contactContainer);
                }
            } else {
                // Em dispositivos grandes: inserir após o container principal (comportamento original)
                const servicesContainer = document.querySelector('.new_order-block');
                if (servicesContainer) {
                    servicesContainer.parentNode.insertBefore(successMessage, servicesContainer.nextSibling);
                }
            }
        }

        // criarAcao agora aceita tokenOpcional (string)
        async function criarAcao(formData, tokenOpcional = null) {
            // tenta usar o token passado; senão carrega do localStorage
            const token = tokenOpcional || loadToken();

            console.log('→ criarAcao usando token:', token);

            if (!token) {
                throw new Error('Token de autenticação não encontrado');
            }

            try {
                const response = await fetch('https://smmsociais.com/api/criar_acao_tiktok', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                if (!response.ok) {
                    // tenta ler texto primeiro (mais seguro), depois JSON
                    const text = await response.text().catch(() => null);
                    let errorMsg = text;
                    try {
                        const json = text ? JSON.parse(text) : null;
                        if (json && json.error) errorMsg = json.error;
                    } catch (e) { /* não-JSON */ }

                    console.error('criar_acao response NOT OK:', response.status, errorMsg);
                    if (response.status === 401) {
                        throw new Error('Não autorizado');
                    }
                    throw new Error(errorMsg || 'Erro ao criar ação');
                }

                const result = await response.json();
                return result;

            } catch (error) {
                console.error('Erro na criação da ação:', error);
                throw error;
            }
        }

        // --- Ao mudar de serviço, configurar min/max corretamente ---
        function handleServiceChange() {
            const selectedOption = this.options[this.selectedIndex];
            if (!selectedOption) return;

            const price = selectedOption.getAttribute('data-price');
            const description = selectedOption.getAttribute('data-description');
            const minAttr = selectedOption.getAttribute('data-min');
            const maxAttr = selectedOption.getAttribute('data-max');

            // conversão segura de limites
            const minQuantity = (minAttr !== null && minAttr !== '') ? parseInt(minAttr, 10) : null;
            const maxQuantity = (maxAttr !== null && maxAttr !== '') ? parseInt(maxAttr, 10) : null;

            // Atualizar preço
            const quantityInput = document.getElementById('orderform-quantity');
            const currentQuantity = quantityInput ? quantityInput.value || (minQuantity !== null ? minQuantity : '') : '';
            updateChargeField(price, currentQuantity);

            // Atualizar descrição
            const descriptionPanel = document.querySelector('.panel-description');
            if (description && descriptionPanel) {
                descriptionPanel.innerHTML = description.replace(/\n/g, '<br>');
                const serviceDescription = document.getElementById('service_description');
                if (serviceDescription) {
                    serviceDescription.classList.remove('hidden');
                }
            } else if (descriptionPanel) {
                descriptionPanel.innerHTML = '';
                const serviceDescription = document.getElementById('service_description');
                if (serviceDescription) {
                    serviceDescription.classList.add('hidden');
                }
            }

            // Mostrar/ocultar campos de link e quantidade
            const linkField = document.getElementById('link_field');
            const quantityField = document.getElementById('quantity_field');

            if (selectedOption.value) {
                if (linkField) linkField.classList.remove('hidden');
                if (quantityField) quantityField.classList.remove('hidden');

                // Configurar limites da quantidade no input de forma segura
                if (quantityInput) {
                    if (minQuantity !== null) {
                        quantityInput.min = minQuantity;
                        quantityInput.placeholder = `Mínimo: ${minQuantity}`;
                    } else {
                        quantityInput.removeAttribute('min');
                    }

                    if (maxQuantity !== null) {
                        quantityInput.max = maxQuantity;
                        // placeholder já mostra mínimo; vamos juntar info se existir max
                        const minText = minQuantity !== null ? `Mínimo: ${minQuantity}, ` : '';
                        quantityInput.placeholder = `${minText}Máximo: ${maxQuantity}`;
                    } else {
                        quantityInput.removeAttribute('max');
                    }

                    // Preencher quantidade mínima automaticamente se estiver vazio
                    if (minQuantity !== null && !quantityInput.value) {
                        quantityInput.value = minQuantity;
                        updateChargeField(price, minQuantity);
                    }
                }
            } else {
                if (linkField) linkField.classList.add('hidden');
                if (quantityField) quantityField.classList.add('hidden');
            }
        }

        // --- Ao mudar a quantidade pelo input ---
        function handleQuantityChange() {
            const serviceSelect = document.getElementById('orderform-service');
            if (!serviceSelect) return;

            const selectedOption = serviceSelect.options[serviceSelect.selectedIndex];
            const price = selectedOption ? selectedOption.getAttribute('data-price') : null;

            // sanitiza a quantidade para números antes de atualizar
            const raw = this.value;
            const sanitized = raw ? String(raw).replace(/[^\d]/g, '') : '';
            if (sanitized !== raw) {
                // opcional: atualiza o campo para remover chars inválidos
                this.value = sanitized;
            }

            if (price) {
                updateChargeField(price, sanitized);
            }
        }

        // --- Envio do formulário com validação numérica correta ---
        async function handleFormSubmit(event) {
            event.preventDefault();

            const submitButton = event.target.querySelector('button[type="submit"]');
            const originalText = submitButton ? submitButton.textContent : 'Enviar';

            try {
                if (submitButton) {
                    submitButton.textContent = 'Enviando...';
                    submitButton.disabled = true;
                }
                document.body.classList.add('loading');

                // Obter dados do formulário
                const serviceSelect = document.getElementById('orderform-service');
                if (!serviceSelect || !serviceSelect.value) {
                    throw new Error('Por favor, selecione um serviço');
                }
                const selectedOption = serviceSelect.options[serviceSelect.selectedIndex];

                const linkInput = document.getElementById('orderform-link');
                const link = linkInput ? linkInput.value.trim() : '';
                if (!link) throw new Error('Por favor, informe o link');

                const quantityInput = document.getElementById('orderform-quantity');
                const quantityRaw = quantityInput ? quantityInput.value : '';
                const quantity = parseInt(String(quantityRaw).replace(/[^\d]/g, ''), 10);

                const minAttr = selectedOption.getAttribute('data-min');
                const maxAttr = selectedOption.getAttribute('data-max');
                const minQuantity = (minAttr !== null && minAttr !== '') ? parseInt(minAttr, 10) : null;
                const maxQuantity = (maxAttr !== null && maxAttr !== '') ? parseInt(maxAttr, 10) : null;

                // Validações numéricas
                if (isNaN(quantity) || quantity <= 0) {
                    throw new Error('Quantidade inválida para este serviço');
                }
                if (minQuantity !== null && quantity < minQuantity) {
                    throw new Error(`Quantidade abaixo do mínimo (${minQuantity})`);
                }
                if (maxQuantity !== null && quantity > maxQuantity) {
                    throw new Error(`Quantidade acima do máximo (${maxQuantity})`);
                }

                const pricePer1000 = selectedOption.getAttribute('data-price');
                const totalValue = calculateTotal(pricePer1000, quantity);

                // Obter informações do usuário
                const userInfo = await getUserInfo();
                // sugerido (aceita vários campos possíveis)
                if (!userInfo || !(userInfo.userId || userInfo.id || userInfo._id || userInfo.token)) {
                    throw new Error('Não foi possível obter informações do usuário');
                }

                // Preparar dados para a API
                const actionData = {
                    rede: selectedOption.getAttribute('data-rede'),
                    tipo: selectedOption.getAttribute('data-tipo'),
                    nome: selectedOption.textContent,
                    valor: totalValue,
                    quantidade: parseInt(quantity, 10),
                    link: link,
                    userId: userInfo.userId,
                    id_servico: serviceSelect.value
                };

                // Chamar API para criar ação
                const result = await criarAcao(actionData);

                // Se a API retornou novo saldo, atualiza o display IMEDIATAMENTE
                if (result && typeof result.newSaldo !== 'undefined') {
                    const balanceElement = document.querySelector('.component-navbar-balance-item__navbar-private');
                    if (balanceElement) {
                        const formatted = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(result.newSaldo || 0);
                        balanceElement.textContent = formatted;
                    }
                } else {
                    // fallback: recarrega saldo do servidor
                    await loadUserBalance();
                }

                // Mostrar notificação e mensagem de sucesso
                showNotification(`Pedido criado com sucesso! ID: ${result.id_pedido}`, 'success');
                showSuccessMessage(`Pedido enviado com sucesso! ID: ${result.id_pedido}`);

                // Limpar apenas os campos específicos, mantendo o container expandido
                const chargeInput = document.getElementById('charge');
                if (chargeInput) chargeInput.value = '';

                const linkInputField = document.getElementById('orderform-link');
                if (linkInputField) linkInputField.value = ''; // Remove apenas o valor do link

                // NÃO esconder os campos para manter o container expandido
                // Apenas limpar os valores dos campos sensíveis

            } catch (error) {
                console.error('Erro ao processar pedido:', error);
                showNotification(error.message || 'Erro ao processar pedido', 'danger');
            } finally {
                if (submitButton) {
                    submitButton.textContent = originalText;
                    submitButton.disabled = false;
                }
                document.body.classList.remove('loading');
            }
        }

        // Configurar event listener para o formulário
        document.addEventListener('DOMContentLoaded', function () {
            const orderForm = document.getElementById('order-form');
            if (orderForm) {
                orderForm.addEventListener('submit', handleFormSubmit);
            }

            // Reaplicar o posicionamento da mensagem quando a janela for redimensionada
            window.addEventListener('resize', function () {
                const existingMessage = document.getElementById('success-message');
                if (existingMessage) {
                    const messageText = existingMessage.textContent;
                    existingMessage.remove();
                    showSuccessMessage(messageText);
                }
            });
        });
    </script>
    <link rel="stylesheet" type="text/css" href="https://storage.perfectcdn.com/global/tad3g2kcwfrtr6yi.css">
    <link rel="stylesheet" type="text/css" href="https://storage.perfectcdn.com/ahnerj/2pcamz1sqmak1hf9.css">
    <script>
        window.modules = {};
    </script>
</head>

<body class="body  body-internal">
    <div class="wrapper  wrapper-sidebar-navbar ">
        <div id="block_52" class="component_private_navbar">
            <span class="component_private_navbar ">
                <div class="component-navbar-private__wrapper component_private_sidebar ">
                    <div
                        class="sidebar-block__top component-navbar component-navbar__navbar-private editor__component-wrapper ">
                        <div>
                            <nav class="navbar navbar-expand-lg navbar-light">
                                <div class="navbar-private__header">
                                    <div class="sidebar-block__top-brand">
                                        <a href="/" class="component-navbar-brand component-navbar-public-brand">
                                            <h3><strong style="font-weight: bold"></strong><span
                                                    style="color: var(--color-id-117)"><strong
                                                        style="font-weight: bold">SMM SOCIAIS</strong></span></h3>
                                        </a>
                                    </div>
                                    <button class="navbar-toggler" type="button" data-toggle="collapse"
                                        data-target="#navbar-collapse-52" aria-controls="navbar-collapse-52"
                                        aria-expanded="false" aria-label="Toggle navigation">
                                        <span class="navbar-burger">
                                            <span class="navbar-burger-line"></span>
                                        </span>
                                    </button>
                                </div>
                                <div class="collapse navbar-collapse" id="navbar-collapse-52">
                                    <div class="component-navbar-collapse-divider"></div>
                                    <div class="d-flex component-navbar-collapse">
                                        <ul class="navbar-nav navbar-nav-sidebar-menu">
                                            <li
                                                class="nav-item component-navbar-nav-item component-navbar-private-nav-item">
                                                <a class="component-navbar-nav-link  component-navbar-nav-link__navbar-private component-navbar-nav-link-active__navbar-private"
                                                    href="/">
                                                    Novo pedido
                                                </a>
                                            </li>
                                            <li
                                                class="nav-item component-navbar-nav-item component-navbar-private-nav-item">
                                                <a class="component-navbar-nav-link  component-navbar-nav-link__navbar-private "
                                                    href="/services">
                                                    Serviços
                                                </a>
                                            </li>
                                            <li
                                                class="nav-item component-navbar-nav-item component-navbar-private-nav-item">
                                                <a class="component-navbar-nav-link  component-navbar-nav-link__navbar-private "
                                                    href="/orders">
                                                    Ordens
                                                </a>
                                            </li>
                                            <li
                                                class="nav-item component-navbar-nav-item component-navbar-private-nav-item">
                                                <a class="component-navbar-nav-link  component-navbar-nav-link__navbar-private "
                                                    href="/addfunds">
                                                    Adicionar Saldo
                                                </a>
                                            </li>
                                            <li
                                                class="nav-item component-navbar-nav-item component-navbar-private-nav-item">
                                                <a class="component-navbar-nav-link  component-navbar-nav-link__navbar-private "
                                                    href="/affiliates">
                                                    Meus indicados
                                                </a>
                                            </li>
                                            <li
                                                class="nav-item component-navbar-nav-item component-navbar-private-nav-item">
                                                <a class="component-navbar-nav-link  component-navbar-nav-link__navbar-private "
                                                    href="/massorder">
                                                    Mass order
                                                </a>
                                            </li>
                                            <li
                                                class="nav-item component-navbar-nav-item component-navbar-private-nav-item">
                                                <a class="component-navbar-nav-link  component-navbar-nav-link__navbar-private "
                                                    href="/suporte">
                                                    Suporte
                                                </a>
                                            </li>
                                        </ul>
                                        <ul class="navbar-nav navbar-nav-currencies">
                                            <li
                                                class="nav-item d-flex align-items-center component-navbar-nav-item component-navbar-private-nav-item component-navbar-balance-wrap__navbar-private">
                                                <a class="component-navbar-balance-item__navbar-private">R$ 0,00</a>
                                            </li>
                                        </ul>
                                        <ul class="navbar-nav">
                                            <li
                                                class="nav-item component-navbar-nav-item component-navbar-private-nav-item">
                                                <a class="component-navbar-nav-link  component-navbar-nav-link__navbar-private"
                                                    href="/account">Conta</a>
                                            </li>
                                            <li
                                                class="nav-item component-navbar-nav-item component-navbar-private-nav-item">
                                                <a class="component-navbar-nav-link  component-navbar-nav-link__navbar-private"
                                                    href="/">Sair</a>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </nav>
                        </div>
                    </div>
                </div>
            </span>
            <span class="component_private_sidebar ">
                <div class="component-sidebar_wrapper">
                    <div
                        class="sidebar-block__left component-sidebar component-sidebar-with-navbar component_private_navbar editor__component-wrapper">
                        <div class="component-sidebar__menu">
                            <div class="component-sidebar__menu-logo">
                                <a href="/painel" class="component-navbar-brand component-sidebar__menu-brand">
                                    <h3><strong style="font-weight: bold">SMM </strong><span
                                            style="font-weight: bold">SOCIAIS</strong></span></h3>
                                </a>
                            </div>
                            <ul class="sidebar-block__left-menu editor__component-wrapper">
                                <li class="component-sidebar__menu-item component-sidebar__menu-item-active">
                                    <a class="component-sidebar__menu-item-link" href="/">
                                        Novo pedido
                                    </a>
                                </li>
                                <li class="component-sidebar__menu-item ">
                                    <a class="component-sidebar__menu-item-link" href="/services">
                                        Serviços
                                    </a>
                                </li>
                                <li class="component-sidebar__menu-item ">
                                    <a class="component-sidebar__menu-item-link" href="/orders">
                                        Ordens
                                    </a>
                                </li>
                                <li class="component-sidebar__menu-item ">
                                    <a class="component-sidebar__menu-item-link" href="/addfunds">
                                        Adicionar Saldo
                                    </a>
                                </li>
                                <li class="component-sidebar__menu-item ">
                                    <a class="component-sidebar__menu-item-link" href="/affiliates">
                                        Meus indicados
                                    </a>
                                </li>
                                <li class="component-sidebar__menu-item ">
                                    <a class="component-sidebar__menu-item-link" href="/massorder">
                                        Mass order
                                    </a>
                                </li>
                                <li class="component-sidebar__menu-item ">
                                    <a class="component-sidebar__menu-item-link" href="/suporte">
                                        Suporte
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </span>
        </div>
        <div class="wrapper-content">
            <div class="wrapper-content__header">
            </div>
            <div class="wrapper-content__body">
                <!-- Main variables *content* -->
                <div id="block_60">
                    <div class="block-bg"></div>
                    <div class="container-fluid">
                        <div class="new_order-block ">
                            <div class="row">
                                <div class="col-lg-7 mb-3 mb-lg-0">
                                    <div
                                        class="component_form_group component_card component_radio_button component_platforms">
                                        <div class="card ">
                                            <form action="/" method="post" id="order-form">
                                                <div class="component_button_forms">
                                                    <div class="form-group">
                                                        <div class="search-dropdown" id="new-order-search"
                                                            style="position: relative;"
                                                            data-lang-placeholder="Procurar">
                                                            <div class="input-wrapper" style="position: relative;">
                                                                <button
                                                                    style="position: absolute;top: 50%;transform: translateY(-50%);padding: 0px 2px;background: none;border: none;left: 12px;"
                                                                    type="button">
                                                                    <span class="fas fa-search"></span>
                                                                </button>
                                                                <input type="text" class="form-control"
                                                                    id="template-input" value="" placeholder="Procurar">
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="form-group">
                                                        <label for="orderform-category"
                                                            class="control-label">Categoria</label>
                                                        <select class="form-control" id="orderform-category"
                                                            name="OrderForm[category]" data-select="true"
                                                            data-select-search="true"
                                                            data-select-search-placeholder="Procurar"
                                                            data-select-container="#select-category-container">
                                                            <option value="-1" data-icon="
                                                                                              <span class='fas fa-star'></span>
                                                                                         " selected>
                                                                Favorite services
                                                            </option>
                                                            <!-- Categorias serão preenchidas dinamicamente -->
                                                        </select>
                                                        <div id="select-category-container" class="position-relative">
                                                        </div>
                                                    </div>
                                                    <div class="form-group">
                                                        <label for="orderform-service"
                                                            class="control-label">Serviço</label>
                                                        <div class="d-flex">
                                                            <div class="w-100 new_order-block__services-list">
                                                                <select class="form-control" id="orderform-service"
                                                                    name="OrderForm[service]" data-select="true"
                                                                    data-select-search="true"
                                                                    data-select-search-placeholder="Procurar"
                                                                    data-select-container="#select-service-container">
                                                                    <option value="" selected>Carregando serviços...
                                                                    </option>
                                                                </select>
                                                                <div id="select-service-container"
                                                                    class="position-relative"></div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="form-group hidden fields component_service_description"
                                                        id="service_description">
                                                        <label for="service_description"
                                                            class="control-label">Descrição</label>
                                                        <div class="panel-description">

                                                        </div>
                                                    </div>
                                                    <!-- Campos adicionados: Link e Quantidade -->
                                                    <div class="form-group hidden" id="link_field">
                                                        <label for="orderform-link" class="control-label">Link</label>
                                                        <input type="text" class="form-control" id="orderform-link"
                                                            name="OrderForm[link]" placeholder="Cole o link aqui">
                                                    </div>
                                                    <div class="form-group hidden" id="quantity_field">
                                                        <label for="orderform-quantity"
                                                            class="control-label">Quantidade</label>
                                                        <input type="number" class="form-control"
                                                            id="orderform-quantity" name="OrderForm[quantity]"
                                                            placeholder="Digite a quantidade" min="0">
                                                    </div>
                                                    <div id="fields"></div>
                                                    <div class="form-group">
                                                        <label for="charge" class="control-label">Valor</label>
                                                        <input type="text" class="form-control" id="charge" value=""
                                                            readonly>
                                                    </div>
                                                </div>
                                                <input type="hidden" name="_csrf"
                                                    value="Xbole38fGiDW4C4919TBihZOb3zsg6y7CdYCRlPW1hAqzX0tNW9zTe-SenyHhY7HIQEeG8Ht3NZ8gnURPbHmRg==">
                                                <div class="new-order-button-submit component_button_submit ">
                                                    <button type="submit"
                                                        class="btn btn-block btn-big-primary">Enviar</button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-5">
                                    <div class="component_content_card component_content_button">
                                        <div class="card">
                                            <div class="new-order__content-title">
                                                <div class="position-relative">
                                                    <p>Para usar nossos serviços clique em <a target="_self"
                                                            href="/addfunds">"Adicionar saldo"</a> ou <a target="_self"
                                                            href="/addfunds">aqui</a></p>
                                                    <p><br></p>
                                                    <p><br></p>
                                                    <p>Aceitamos somente <a target="_self" href="/addfunds">Pix</a> <a
                                                            target="_self" href="/addfunds">- clique aqui para
                                                            recarregar o &nbsp;seu saldo - </a>(Tudo integrado de forma
                                                        automática, ou seja, você faz o Pix e ele entra no seu saldo na
                                                        mesma hora! Se atente a usar a opção "Pix copia e cola"</p>
                                                    <p>Caso você NÃO saiba utilizar a opção "Copia e cola" do Pix, <a
                                                            target="_blank"
                                                            href="https://www.youtube.com/watch?v=YIenNQLvb9g">clique
                                                            aqui</a></p>
                                                    <p><br></p>
                                                    <p>Estamos dando 10% de comissão para todas as compras que seus
                                                        amigos fizerem tendo se cadastrado no seu link! Para entender
                                                        melhor <a target="_self" href="/affiliates">clique aqui</a></p>
                                                </div>
                                            </div>
                                            <div class="new-order__content-text">
                                                <p>Somos uma empresa de publicidade digital, com diversos serviços à sua
                                                    disposição para alavancar seu perfil nas redes sociais,
                                                    proporcionando novas oportunidades para você ou sua empresa!&nbsp;
                                                </p>
                                                <p>Suporte das 6:30 até às 22 horas de segunda-feira a sexta-feira</p>
                                                <p><br></p>
                                                <h1>CONTATO</h1>
                                                <p><br></p>
                                                <p><br></p>
                                                <p><strong style="font-weight: bold">E-mail</strong>:
                                                    contato@smmsociais.com</p>
                                                <p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Nosso Instagram é <a target="_blank"
                                                        href="https://www.instagram.com/smmsociais/">@smmsociais</a>
                                                    &nbsp;</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="block_74">
                    <div class="block-bg"></div>
                    <div class="container">
                        <div class="text-block-with-image ">
                            <div class="row">
                                <div class="col">
                                    <div class="d-md-flex align-items-start">
                                        <div class="text-block__description">
                                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                                            </p>
                                            <p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</p>
                                            <p class="text-left"><span style="text-align: LEFT">Ao acessar ao site ,
                                                    você concorda em cumprir os nossos termos de serviço assim como
                                                    todas as leis e regulamentos aplicáveis ​​e concorda que é
                                                    responsável pelo cumprimento de todas as leis locais aplicáveis. Se
                                                    você não concordar com algum desses termos, está proibido de usar ou
                                                    acessar este site. Os materiais contidos neste site são protegidos
                                                    pelas leis de direitos autorais e mardas comerciais aplicáveis.
                                                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                                            </p>
                                        </div>
                                        <div class="text-block__image">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                </a>
            </div>
        </div>
    </div>
    </div>
    </div>
    </div>
    </div>
    </div>
    <div class="wrapper-content__footer">
    </div>
    </div>
    </div>
    <!-- Notifications wrapper -->
    <div id="notify-wrapper" class="alert alert-success mb-3 hidden" style="display: none;"></div>

    <!-- ======= Navbar toggle fallback (vanilla JS) - torna o "hamburger" funcional em dispositivos móveis ======= -->
    <script>
        (function () {
            // Função utilitária para encontrar o alvo do botão (data-target ou aria-controls)
            function resolveTarget(button) {
                const targetSelector = button.getAttribute('data-target') || button.getAttribute('data-bs-target') || ('#' + (button.getAttribute('aria-controls') || ''));
                if (!targetSelector) return null;
                try {
                    return document.querySelector(targetSelector);
                } catch (e) {
                    return null;
                }
            }

            // Inicializa todos os togglers de navbar existentes
            function initNavTogglers() {
                const togglers = document.querySelectorAll('.navbar-toggler');
                togglers.forEach(btn => {
                    const target = resolveTarget(btn);
                    if (!target) return;

                    // Garantir que o botão tenha type="button" para evitar submit acidental
                    if (!btn.hasAttribute('type')) btn.setAttribute('type', 'button');

                    // Evitar duplicar event listeners
                    if (btn.__nav_init) return;
                    btn.__nav_init = true;

                    btn.addEventListener('click', function (e) {
                        e.preventDefault();
                        const isShown = target.classList.contains('show');
                        if (isShown) {
                            target.classList.remove('show');
                            btn.classList.remove('collapsed');
                            btn.setAttribute('aria-expanded', 'false');
                        } else {
                            target.classList.add('show');
                            btn.classList.add('collapsed');
                            btn.setAttribute('aria-expanded', 'true');
                        }
                    });

                    // Fechar ao clicar fora (somente se estiver aberto)
                    document.addEventListener('click', function (ev) {
                        if (!target.classList.contains('show')) return;
                        if (btn.contains(ev.target) || target.contains(ev.target)) return;
                        target.classList.remove('show');
                        btn.setAttribute('aria-expanded', 'false');
                    });

                    // Fechar ao pressionar ESC
                    document.addEventListener('keydown', function (ev) {
                        if (ev.key === 'Escape' && target.classList.contains('show')) {
                            target.classList.remove('show');
                            btn.setAttribute('aria-expanded', 'false');
                        }
                    });

                    // Ao redimensionar para telas grandes, garantir menu fechado
                    window.addEventListener('resize', function () {
                        if (window.innerWidth >= 992 && target.classList.contains('show')) {
                            target.classList.remove('show');
                            btn.setAttribute('aria-expanded', 'false');
                        }
                    });
                });
            }

            // Inicializar no DOM ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initNavTogglers);
            } else {
                initNavTogglers();
            }
        })();
    </script>

    <!-- Script para garantir que a página apareça apenas após todas as APIs terminarem -->
    <script>
        (function () {
            // mostra um overlay loader enquanto aguarda
            const loader = document.createElement('div');
            loader.id = 'page-loader';
            loader.innerHTML = `
                <div style="text-align:center">
                    <div class="spinner-border" role="status" aria-hidden="true"></div>
                    <div style="margin-top:8px">Carregando dados...</div>
                </div>`;
            document.body.appendChild(loader);

            // --- opcional: esperar window.load para garantir recursos externos carregados ---
            const windowLoadPromise = new Promise(resolve => {
                if (document.readyState === 'complete') return resolve();
                window.addEventListener('load', resolve);
            });

            // Executar fillAndHideInput imediatamente (não depende de APIs)
            fillAndHideInput();

            // --- Promise principal: saldo + serviços (+ window.load) ---
            const saldoPromise = loadUserBalance();
            const servicesPromise = loadServices();

            Promise.all([saldoPromise, servicesPromise, windowLoadPromise])
                .then(() => {
                    document.body.classList.add('loaded');

                    // Inicializar campos com valores padrão após um pequeno delay
                    // para garantir que o DOM esteja completamente renderizado
                    setTimeout(() => {
                        initializeDefaultFields();
                    }, 100);
                })
                .catch(err => {
                    // se algo muito inesperado acontecer, logamos e mostramos a página (UX)
                    console.error('Erro ao carregar dados principais:', err);
                    document.body.classList.add('loaded');
                    const serviceSelect = document.getElementById('orderform-service');
                    if (serviceSelect && serviceSelect.innerHTML.includes('Carregando serviços')) {
                        serviceSelect.innerHTML = '<option value="">Erro ao carregar serviços</option>';
                    }
                })
                .finally(() => {
                    // remover loader visual
                    if (loader && loader.parentNode) loader.parentNode.removeChild(loader);
                });

            // Segurança extra: fallback para evitar tela eternamente oculta (ex.: bloqueio de CORS extremo)
            setTimeout(() => {
                if (!document.body.classList.contains('loaded')) {
                    console.warn('Fallback: exibindo página após timeout.');
                    document.body.classList.add('loaded');
                    if (loader && loader.parentNode) loader.parentNode.removeChild(loader);
                }
            }, 15000); // 15s — opcional, ajuste conforme necessidade
        })();
    </script>
</body>

</html>
