<!DOCTYPE html>
<html id="theme_23" lang="pt-BR">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>2FA - SMM SOCIAIS</title>
    <link href="https://storage.perfectcdn.com/global/i1iurhd1aoznbme6.js" rel="preload" as="script">
    <link href="https://storage.perfectcdn.com/global/jq8derbjf313z5ai.js" rel="preload" as="script">
    <link href="https://storage.perfectcdn.com/global/6czummq521hj11q5.js" rel="preload" as="script">
    <link href="https://storage.perfectcdn.com/global/zfq5snh4og5je3zk.js" rel="preload" as="script">

    <link rel="stylesheet" type="text/css" href="https://storage.perfectcdn.com/global/tad3g2kcwfrtr6yi.css">
    <link rel="stylesheet" type="text/css" href="https://storage.perfectcdn.com/ahnerj/2pcamz1sqmak1hf9.css">
    <style>
        /* Estilos para notificações nativas */
        #notify-wrapper {
            position: fixed;
            top: 20px;
            right: 20px;
            max-width: 400px;
            z-index: 9999;
            display: none;
            animation: fadeIn 0.3s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-radius: 6px;
        }
        
        #notify-wrapper.show {
            display: block !important;
        }
        
        .alert-success {
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        
        .alert-danger {
            background-color: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        
        .alert-info {
            background-color: #d1ecf1;
            border-color: #bee5eb;
            color: #0c5460;
        }
        
        .alert-warning {
            background-color: #fff3cd;
            border-color: #ffeeba;
            color: #856404;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Estilos para controles 2FA */
        .btn-resend {
            font-size: 14px;
            padding: 4px 12px;
        }
        
        .btn-resend.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }
        
        .code-info {
            font-size: 13px;
            color: #666;
            margin-top: 5px;
            margin-bottom: 15px;
        }
        
        .timer {
            font-weight: 600;
            color: #28a745;
        }
        
        .timer.expired {
            color: #dc3545;
        }
    </style>
    <script>
        window.modules = {};
    </script>
</head>

<body class="body  body-public">
    <!-- Notifications wrapper -->
    <div id="notify-wrapper" class="alert alert-success mb-3"></div>
    
    <div class="wrapper  wrapper-navbar ">
        <div id="block_49">
            <div class="block-wrapper">
                <div class="component_navbar ">
                    <div class="component-navbar__wrapper">
                        <div
                            class="component-navbar component-navbar__navbar-public component-navbar__navbar-public-padding editor__component-wrapper ">
                            <div>
                                <nav class="navbar navbar-expand-lg navbar-light navbar-rows">
                                    <div class="navbar-public__header">
                                        <div class="sidebar-block__top-brand">
                                            <a href="/" class="component-navbar-brand component-navbar-public-brand">
                                                <h1><span style="color: var(--color-id-117)">SMM SOCIAIS</span></h1>
                                            </a>
                                        </div>
                                        <button class="navbar-toggler" type="button" data-toggle="collapse"
                                            data-target="#navbar-collapse-49" aria-controls="navbar-collapse-49"
                                            aria-expanded="false" aria-label="Toggle navigation">
                                            <span class="navbar-burger">
                                                <span class="navbar-burger-line"></span>
                                            </span>
                                        </button>
                                    </div>
                                    <div class="collapse navbar-collapse" id="navbar-collapse-49">
                                        <div class="d-flex flex-wrap component-navbar-collapse">
                                            <ul class="navbar-nav">
                                                <li
                                                    class="nav-item component-navbar-nav-item component-navbar-public-nav-item nav-item-height">
                                                    <a class="component-navbar-nav-link component-navbar-nav-link__navbar-public "
                                                        href="/"> Fazer Login</a>
                                                </li>
                                                <li
                                                    class="nav-item component-navbar-nav-item component-navbar-public-nav-item nav-item-height">
                                                    <a class="component-navbar-nav-link component-navbar-nav-link__navbar-public "
                                                        href="/servicos"> Serviços</a>
                                                </li>
                                                <li
                                                    class="nav-item component-navbar-nav-item component-navbar-public-nav-item nav-item-height">
                                                    <a class="component-navbar-nav-link component-navbar-nav-link__navbar-public "
                                                        href="/signup"> Criar Conta</a>
                                                </li>
                                                <li
                                                    class="nav-item component-navbar-nav-item component-navbar-public-nav-item nav-item-height">
                                                    <a class="component-navbar-nav-link component-navbar-nav-link__navbar-public "
                                                        href="/termos"> Termos</a>
                                                </li>
                                            </ul>
                                        </div>
                                    </div>
                                </nav>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="wrapper-content">
            <div class="wrapper-content__header">
            </div>
            <div class="wrapper-content__body">
                <!-- Main variables *content* -->
                <div id="block_79">
                    <div class="block-bg"></div>
                    <div class="container">
                        <div class="block-2fa">
                            <div class="row form-alignment">
                                <div class="col-lg-6">
                                    <div class="component_card">
                                        <div class="card">
                                            <form method="post" action="/2fa" class="component_form_group" id="2fa-form">
                                                <h4>Autenticação de dois fatores</h4>
                                                <div class="mb-4">Por favor, verifique seu e-mail e insira o código abaixo.</div>
                                                <div id="2fa-info" class="code-info">
                                                    <!-- Informações sobre o código serão inseridas aqui -->
                                                </div>
                                                <div class="">
                                                    <div class="form-group">
                                                        <label for="code" class="control-label">Código</label>
                                                        <input type="text" autocomplete="off" class="form-control"
                                                            id="code" name="code" placeholder="Digite o código recebido">
                                                    </div>
                                                </div>
                                                <div id="2fa-controls" class="mb-3">
                                                    <!-- Controles de timer e reenvio serão inseridos aqui -->
                                                </div>
                                                <input type="hidden" name="_csrf"
                                                    value="jnS3mZD5pXDxOL3jmg7d8bz6HHQJovR6jkNXBfd4nhu2LM72yIr_Pdx9_6DiYe3I-qp-MDzGwDvlNCRarkj8aQ==">
                                                <div class="component_button_submit">
                                                    <div class="">
                                                        <button type="submit" id="submit-btn"
                                                            class="btn btn-block btn-big-primary">Continuar</button>
                                                    </div>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="wrapper-content__footer">
                <div id="block_66">
                    <div class="footer ">
                        <div class="component_footer_single_line">
                            <div class="component-footer">
                                <div class="component-footer__public">
                                    <div class="container-fluid">
                                        <div class="row">
                                            <div class="col-md-12">
                                                <div class="component-footer__public-copyright">
                                                    <p class="text-center"><span style="text-align: CENTER">© 2025,
                                                            SMMSociais.</span></p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script type="text/javascript" src="https://storage.perfectcdn.com/global/i1iurhd1aoznbme6.js">
    </script>
    <script type="text/javascript" src="https://storage.perfectcdn.com/global/jq8derbjf313z5ai.js">
    </script>
    <script type="text/javascript" src="https://storage.perfectcdn.com/global/6czummq521hj11q5.js">
    </script>
    <script type="text/javascript" src="https://storage.perfectcdn.com/global/zfq5snh4og5je3zk.js">
    </script>
    <script type="text/javascript">
        window.modules.layouts = { "theme_id": 23, "auth": 0, "live": true, "csrftoken": "jnS3mZD5pXDxOL3jmg7d8bz6HHQJovR6jkNXBfd4nhu2LM72yIr_Pdx9_6DiYe3I-qp-MDzGwDvlNCRarkj8aQ==" };
    </script>
    
    <script>
        // Sistema de notificações nativo
        class NotificationSystem {
            constructor() {
                this.notifyEl = document.getElementById('notify-wrapper');
                this.timeout = null;
                this.queue = [];
                this.isShowing = false;
            }
            
            show(message, type = 'success', duration = 4000) {
                // Adiciona à fila
                this.queue.push({ message, type, duration });
                
                // Se não estiver mostrando nada, processa imediatamente
                if (!this.isShowing) {
                    this.processQueue();
                }
            }
            
            processQueue() {
                if (this.queue.length === 0) {
                    this.isShowing = false;
                    return;
                }
                
                this.isShowing = true;
                const { message, type, duration } = this.queue.shift();
                
                // Limpa timeout anterior
                if (this.timeout) {
                    clearTimeout(this.timeout);
                    this.timeout = null;
                }
                
                // Configura a notificação
                this.notifyEl.textContent = message;
                this.notifyEl.className = 'alert mb-3';
                
                // Define a classe baseada no tipo
                switch(type) {
                    case 'error':
                        this.notifyEl.classList.add('alert-danger');
                        break;
                    case 'warning':
                        this.notifyEl.classList.add('alert-warning');
                        break;
                    case 'info':
                        this.notifyEl.classList.add('alert-info');
                        break;
                    case 'success':
                    default:
                        this.notifyEl.classList.add('alert-success');
                        break;
                }
                
                // Mostra a notificação
                this.notifyEl.classList.add('show');
                
                // Configura timeout para esconder
                if (duration > 0) {
                    this.timeout = setTimeout(() => {
                        this.notifyEl.classList.remove('show');
                        setTimeout(() => this.processQueue(), 300);
                    }, duration);
                }
            }
            
            hide() {
                this.notifyEl.classList.remove('show');
                if (this.timeout) {
                    clearTimeout(this.timeout);
                    this.timeout = null;
                }
                this.isShowing = false;
            }
        }
        
        // Instância global do sistema de notificações
        const notify = new NotificationSystem();
        
        // Função utilitária para mascarar email
        function maskEmail(email) {
            if (!email || typeof email !== 'string') return 'seu email';
            
            const parts = email.split('@');
            if (parts.length !== 2) return email;
            
            const name = parts[0];
            const domain = parts[1];
            
            if (name.length <= 2) return `*@${domain}`;
            return name[0] + '*'.repeat(Math.max(1, name.length - 2)) + name[name.length - 1] + '@' + domain;
        }
        
        // Classe para gerenciar o fluxo 2FA
        class TwoFactorAuth {
            constructor() {
                this.email = null;
                this.resendCooldown = false;
                this.countdownInterval = null;
                this.codeExpiryTime = 300; // 5 minutos em segundos
                this.resendCooldownTime = 60; // 60 segundos para reenvio
            }
            
            async init() {
                // Configurar elementos da UI
                this.setupUI();
                
                // Obter email do usuário
                await this.getUserEmail();
                
                if (!this.email) {
                    notify.show('Não foi possível recuperar seu email. Redirecionando para login...', 'error', 5000);
                    setTimeout(() => { window.location.href = '/login'; }, 3000);
                    return;
                }
                
                // Enviar código inicial
                await this.sendCode();
                
                // Configurar eventos
                this.setupEvents();
            }
            
            setupUI() {
                const formGroup = document.querySelector('.form-group');
                if (!formGroup) return;
                
                // Adicionar informações do código
                const infoDiv = document.getElementById('2fa-info');
                infoDiv.innerHTML = `
                    <div id="email-info">Aguardando email...</div>
                    <div id="timer-info" class="timer"></div>
                `;
                
                // Adicionar controles
                const controlsDiv = document.getElementById('2fa-controls');
                controlsDiv.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <button type="button" id="resend-btn" class="btn btn-resend btn-link">
                                Reenviar código
                            </button>
                        </div>
                        <div id="expiry-timer" class="text-muted small"></div>
                    </div>
                `;
            }
            
            async getUserEmail() {
                try {
                    // Tentar obter da API
                    const response = await this.apiFetch('/api/account');
                    if (response.ok) {
                        const data = await response.json();
                        if (data.email) {
                            this.email = data.email;
                            this.updateEmailInfo();
                            return;
                        }
                    }
                } catch (error) {
                    console.warn('Erro ao buscar email da API:', error);
                }
                
                // Fallback para localStorage
                const storedEmail = localStorage.getItem('loginEmail');
                if (storedEmail) {
                    this.email = storedEmail;
                    this.updateEmailInfo();
                }
            }
            
            updateEmailInfo() {
                const emailInfo = document.getElementById('email-info');
                if (emailInfo && this.email) {
                    emailInfo.textContent = `Código enviado para: ${maskEmail(this.email)}`;
                    
                    // Atualizar placeholder do input
                    const codeInput = document.getElementById('code');
                    if (codeInput) {
                        codeInput.placeholder = `Código enviado para ${maskEmail(this.email)}`;
                    }
                }
            }
            
            async apiFetch(endpoint, options = {}) {
                const token = localStorage.getItem('token');
                const headers = {
                    'Content-Type': 'application/json',
                    ...options.headers
                };
                
                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                }
                
                return fetch(endpoint, {
                    ...options,
                    headers
                });
            }
            
            async sendCode(showNotification = true) {
                if (!this.email) {
                    notify.show('Email não disponível', 'error');
                    return false;
                }
                
                try {
                    const response = await this.apiFetch('/api/2fa/send', {
                        method: 'POST',
                        body: JSON.stringify({ email: this.email })
                    });
                    
                    const data = await response.json();
                    
                    if (!response.ok) {
                        const errorMsg = data.error || data.message || 'Erro ao enviar código';
                        if (showNotification) {
                            notify.show(errorMsg, 'error');
                        }
                        return false;
                    }
                    
                    if (showNotification) {
                        notify.show(`Código enviado para ${maskEmail(this.email)}`, 'success');
                    }
                    
                    // Iniciar contadores
                    this.startExpiryTimer();
                    this.startResendCooldown();
                    
                    return true;
                    
                } catch (error) {
                    console.error('Erro ao enviar código:', error);
                    if (showNotification) {
                        notify.show('Erro de conexão ao enviar código', 'error');
                    }
                    return false;
                }
            }
            
            startExpiryTimer() {
                // Limpar timer anterior
                if (this.countdownInterval) {
                    clearInterval(this.countdownInterval);
                }
                
                let remaining = this.codeExpiryTime;
                const timerElement = document.getElementById('timer-info');
                const expiryTimerElement = document.getElementById('expiry-timer');
                
                const updateDisplay = () => {
                    const minutes = Math.floor(remaining / 60);
                    const seconds = remaining % 60;
                    const timeStr = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                    
                    if (timerElement) {
                        timerElement.textContent = `Expira em: ${timeStr}`;
                        timerElement.className = remaining < 60 ? 'timer expired' : 'timer';
                    }
                    
                    if (expiryTimerElement) {
                        expiryTimerElement.textContent = `Expira em ${timeStr}`;
                    }
                    
                    if (remaining <= 0) {
                        clearInterval(this.countdownInterval);
                        if (timerElement) {
                            timerElement.textContent = 'Código expirado';
                            timerElement.className = 'timer expired';
                        }
                        if (expiryTimerElement) {
                            expiryTimerElement.textContent = 'Código expirado';
                        }
                    }
                };
                
                // Atualizar imediatamente e a cada segundo
                updateDisplay();
                this.countdownInterval = setInterval(() => {
                    remaining--;
                    updateDisplay();
                    
                    if (remaining <= 0) {
                        clearInterval(this.countdownInterval);
                        notify.show('O código expirou. Solicite um novo código.', 'warning');
                    }
                }, 1000);
            }
            
            startResendCooldown() {
                this.resendCooldown = true;
                const resendBtn = document.getElementById('resend-btn');
                if (!resendBtn) return;
                
                let remaining = this.resendCooldownTime;
                
                resendBtn.classList.add('disabled');
                resendBtn.disabled = true;
                
                const updateButton = () => {
                    resendBtn.textContent = `Reenviar (${remaining}s)`;
                    
                    if (remaining <= 0) {
                        this.resendCooldown = false;
                        resendBtn.textContent = 'Reenviar código';
                        resendBtn.classList.remove('disabled');
                        resendBtn.disabled = false;
                        return;
                    }
                    
                    remaining--;
                    setTimeout(updateButton, 1000);
                };
                
                updateButton();
            }
            
            async verifyCode(code) {
                if (!this.email || !code) {
                    notify.show('Email ou código inválido', 'error');
                    return false;
                }
                
                try {
                    const response = await this.apiFetch('/api/2fa/verify', {
                        method: 'POST',
                        body: JSON.stringify({ 
                            email: this.email, 
                            code: code.trim() 
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (!response.ok) {
                        const errorMsg = data.error || data.message || 'Código inválido';
                        notify.show(errorMsg, 'error');
                        return false;
                    }
                    
                    notify.show('Autenticação realizada com sucesso!', 'success');
                    
                    // Processar resposta de sucesso
                    if (data.token) {
                        localStorage.setItem('token', data.token);
                    }
                    
                    if (data.redirect) {
                        window.location.href = data.redirect;
                    } else {
                        window.location.href = '/painel';
                    }
                    
                    return true;
                    
                } catch (error) {
                    console.error('Erro ao verificar código:', error);
                    notify.show('Erro de conexão ao verificar código', 'error');
                    return false;
                }
            }
            
            setupEvents() {
                // Evento do botão de reenvio
                const resendBtn = document.getElementById('resend-btn');
                if (resendBtn) {
                    resendBtn.addEventListener('click', async () => {
                        if (this.resendCooldown) return;
                        await this.sendCode();
                    });
                }
                
                // Evento do formulário
                const form = document.getElementById('2fa-form');
                if (form) {
                    form.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        
                        const codeInput = document.getElementById('code');
                        const submitBtn = document.getElementById('submit-btn');
                        
                        if (!codeInput || !submitBtn) return;
                        
                        const code = codeInput.value.trim();
                        
                        if (!code) {
                            notify.show('Digite o código recebido', 'error');
                            codeInput.focus();
                            return;
                        }
                        
                        // Desabilitar botão durante a verificação
                        const originalText = submitBtn.textContent;
                        submitBtn.disabled = true;
                        submitBtn.textContent = 'Verificando...';
                        
                        // Verificar código
                        await this.verifyCode(code);
                        
                        // Reabilitar botão (caso falhe)
                        submitBtn.disabled = false;
                        submitBtn.textContent = originalText;
                    });
                }
                
                // Focar no campo de código
                const codeInput = document.getElementById('code');
                if (codeInput) {
                    codeInput.focus();
                }
            }
        }
        
        // Inicializar quando o DOM estiver carregado
        document.addEventListener('DOMContentLoaded', () => {
            const twoFactor = new TwoFactorAuth();
            twoFactor.init().catch(error => {
                console.error('Erro ao inicializar 2FA:', error);
                notify.show('Erro ao inicializar autenticação. Recarregue a página.', 'error');
            });
        });
    </script>
</body>
</html>
