<!DOCTYPE html>
<html id="theme_23" lang="pt-BR">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>2FA - SMM SOCIAIS</title>
    <link href="https://storage.perfectcdn.com/global/i1iurhd1aoznbme6.js" rel="preload" as="script">
    <link href="https://storage.perfectcdn.com/global/jq8derbjf313z5ai.js" rel="preload" as="script">
    <link href="https://storage.perfectcdn.com/global/6czummq521hj11q5.js" rel="preload" as="script">
    <link href="https://storage.perfectcdn.com/global/zfq5snh4og5je3zk.js" rel="preload" as="script">

    <link rel="stylesheet" type="text/css" href="https://storage.perfectcdn.com/global/tad3g2kcwfrtr6yi.css">
    <link rel="stylesheet" type="text/css" href="https://storage.perfectcdn.com/ahnerj/2pcamz1sqmak1hf9.css">
    <script>
        window.modules = {};
    </script>
</head>

<body class="body  body-public">
    <div class="wrapper  wrapper-navbar ">
        <div id="block_49">
            <div class="block-wrapper">
                <div class="component_navbar ">
                    <div class="component-navbar__wrapper">
                        <div
                            class="component-navbar component-navbar__navbar-public component-navbar__navbar-public-padding editor__component-wrapper ">
                            <div>
                                <nav class="navbar navbar-expand-lg navbar-light navbar-rows">
                                    <div class="navbar-public__header">
                                        <div class="sidebar-block__top-brand">
                                            <a href="/" class="component-navbar-brand component-navbar-public-brand">
                                                <h1><span style="color: var(--color-id-117)">SMM SOCIAIS</span></h1>
                                            </a>
                                        </div>
                                        <button class="navbar-toggler" type="button" data-toggle="collapse"
                                            data-target="#navbar-collapse-49" aria-controls="navbar-collapse-49"
                                            aria-expanded="false" aria-label="Toggle navigation">
                                            <span class="navbar-burger">
                                                <span class="navbar-burger-line"></span>
                                            </span>
                                        </button>
                                    </div>
                                    <div class="collapse navbar-collapse" id="navbar-collapse-49">
                                        <div class="d-flex flex-wrap component-navbar-collapse">
                                            <ul class="navbar-nav">
                                                <li
                                                    class="nav-item component-navbar-nav-item component-navbar-public-nav-item nav-item-height">
                                                    <a class="component-navbar-nav-link component-navbar-nav-link__navbar-public "
                                                        href="/"> Fazer Login</a>
                                                </li>
                                                <li
                                                    class="nav-item component-navbar-nav-item component-navbar-public-nav-item nav-item-height">
                                                    <a class="component-navbar-nav-link component-navbar-nav-link__navbar-public "
                                                        href="/servicos"> Serviços</a>
                                                </li>
                                                <li
                                                    class="nav-item component-navbar-nav-item component-navbar-public-nav-item nav-item-height">
                                                    <a class="component-navbar-nav-link component-navbar-nav-link__navbar-public "
                                                        href="/signup"> Criar Conta</a>
                                                </li>
                                                <li
                                                    class="nav-item component-navbar-nav-item component-navbar-public-nav-item nav-item-height">
                                                    <a class="component-navbar-nav-link component-navbar-nav-link__navbar-public "
                                                        href="/termos"> Termos</a>
                                                </li>
                                            </ul>
                                        </div>
                                    </div>
                                </nav>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="wrapper-content">
            <div class="wrapper-content__header">
            </div>
            <div class="wrapper-content__body">
                <!-- Main variables *content* -->
                <div id="block_79">
                    <div class="block-bg"></div>
                    <div class="container">
                        <div class="block-2fa">
                            <div class="row form-alignment">
                                <div class="col-lg-6">
                                    <div class="component_card">
                                        <div class="card">
                                            <form method="post" action="/2fa" class="component_form_group">
                                                <h4>Autenticação de dois fatores</h4>
                                                <div class="mb-4 ">Por favor, verifique seu e-mail e insira o código
                                                    abaixo.</div>
                                                <div class="">
                                                    <div class="form-group">
                                                        <label for="code" class="control-label">Código</label>
                                                        <input type="text" autocomplete="off" class="form-control"
                                                            id="code" name="code">
                                                    </div>
                                                </div>
                                                <input type="hidden" name="_csrf"
                                                    value="jnS3mZD5pXDxOL3jmg7d8bz6HHQJovR6jkNXBfd4nhu2LM72yIr_Pdx9_6DiYe3I-qp-MDzGwDvlNCRarkj8aQ==">
                                                <div class="component_button_submit">
                                                    <div class="">
                                                        <button type="submit"
                                                            class="btn btn-block btn-big-primary">Continuar</button>
                                                    </div>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="wrapper-content__footer">
                <div id="block_66">
                    <div class="footer ">
                        <div class="component_footer_single_line">
                            <div class="component-footer">
                                <div class="component-footer__public">
                                    <div class="container-fluid">
                                        <div class="row">
                                            <div class="col-md-12">
                                                <div class="component-footer__public-copyright">
                                                    <p class="text-center"><span style="text-align: CENTER">© 2025,
                                                            SMMSociais.</span></p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Notifications wrapper -->
    <div id="notify-wrapper" class="alert alert-success mb-3 hidden" style="display: none;"></div>
    <script type="text/javascript" src="https://storage.perfectcdn.com/global/i1iurhd1aoznbme6.js">
    </script>
    <script type="text/javascript" src="https://storage.perfectcdn.com/global/jq8derbjf313z5ai.js">
    </script>
    <script type="text/javascript" src="https://storage.perfectcdn.com/global/6czummq521hj11q5.js">
    </script>
    <script type="text/javascript" src="https://storage.perfectcdn.com/global/zfq5snh4og5je3zk.js">
    </script>
    <script type="text/javascript">
        window.modules.layouts = { "theme_id": 23, "auth": 0, "live": true, "csrftoken": "jnS3mZD5pXDxOL3jmg7d8bz6HHQJovR6jkNXBfd4nhu2LM72yIr_Pdx9_6DiYe3I-qp-MDzGwDvlNCRarkj8aQ==" };   </script>
    <script type="text/javascript">
    </script>
<script>
document.addEventListener('DOMContentLoaded', init2FAPage);

function showNotification(message, type = 'success', timeout = 4000) {
  const notify = document.getElementById('notify-wrapper');
  if (!notify) {
    alert(message);
    return;
  }
  notify.className = 'alert alert-' + (type === 'error' ? 'danger' : type);
  notify.textContent = message;
  notify.style.display = 'block';
  if (timeout > 0) setTimeout(() => { notify.style.display = 'none'; }, timeout);
}

async function apiFetch(path, options = {}) {
  const token = localStorage.getItem('token');
  options.headers = Object.assign({ 'Content-Type': 'application/json' }, options.headers || {});
  if (token) options.headers['Authorization'] = 'Bearer ' + token;
  return fetch(path, options);
}

function maskEmail(email) {
  // mostra email mascarado (ex: r****n@gmail.com)
  const parts = String(email).split('@');
  if (parts.length !== 2) return email;
  const name = parts[0];
  const domain = parts[1];
  if (name.length <= 2) return `*@${domain}`;
  return name[0] + '*'.repeat(Math.max(1, name.length - 2)) + name[name.length - 1] + '@' + domain;
}

let resendCooldown = false;
let countdownInterval = null;

async function send2FACode(email, showMsg = true) {
  try {
    const res = await apiFetch('/api/2fa/send', {
      method: 'POST',
      body: JSON.stringify({ email })
    });

    const data = await res.json();
    if (!res.ok) {
      console.error('Erro /api/2fa/send:', data);
      if (showMsg) showNotification(data.error || 'Erro ao enviar código 2FA', 'error');
      return false;
    }

    if (showMsg) showNotification('Código 2FA enviado para ' + maskEmail(email), 'success');
    startCountdown(300); // 5 minutos para expiração do código
    startResendCooldown(60); // 60s até permitir reenvio
    return true;
  } catch (err) {
    console.error('Erro ao enviar 2FA:', err);
    showNotification('Erro ao enviar código 2FA', 'error');
    return false;
  }
}

function startCountdown(seconds) {
  const timerEl = document.getElementById('2fa-timer');
  if (!timerEl) return;
  clearInterval(countdownInterval);
  let t = seconds;
  timerEl.textContent = formatTime(t);
  countdownInterval = setInterval(() => {
    t--;
    if (t < 0) {
      clearInterval(countdownInterval);
      timerEl.textContent = 'Código expirado';
      return;
    }
    timerEl.textContent = formatTime(t);
  }, 1000);
}

function formatTime(t) {
  const m = Math.floor(t / 60);
  const s = t % 60;
  return `Código expira em: ${m}:${s < 10 ? '0' : ''}${s}`;
}

function startResendCooldown(seconds) {
  const resendBtn = document.getElementById('2fa-resend');
  if (!resendBtn) return;
  resendCooldown = true;
  let t = seconds;
  resendBtn.textContent = `Reenviar (${t}s)`;
  resendBtn.classList.add('disabled');
  const iv = setInterval(() => {
    t--;
    if (t <= 0) {
      clearInterval(iv);
      resendCooldown = false;
      resendBtn.textContent = 'Reenviar código';
      resendBtn.classList.remove('disabled');
      return;
    }
    resendBtn.textContent = `Reenviar (${t}s)`;
  }, 1000);
}

async function verify2FACode(email, code) {
  try {
    const res = await apiFetch('/api/2fa/verify', {
      method: 'POST',
      body: JSON.stringify({ email, code })
    });
    const data = await res.json();
    if (!res.ok) {
      showNotification(data.error || 'Código inválido', 'error');
      return false;
    }
    showNotification('2FA verificado com sucesso!', 'success');
    return true;
  } catch (err) {
    console.error('Erro /api/2fa/verify:', err);
    showNotification('Erro ao verificar 2FA', 'error');
    return false;
  }
}

async function getEmailFor2FA() {
  // tenta pegar email via /api/account (token necessário)
  try {
    const resp = await apiFetch('/api/account', { method: 'GET' });
    if (resp.ok) {
      const data = await resp.json();
      if (data.email) return data.email;
    }
  } catch (err) {
    console.warn('Falha ao buscar /api/account:', err);
  }
  // fallback: usar loginEmail salvo no localStorage (colocar no login: localStorage.setItem('loginEmail', username))
  const fallback = localStorage.getItem('loginEmail');
  if (fallback) return fallback;
  return null;
}

async function init2FAPage() {
  // insere UI extras (timer + resend) dinamicamente logo abaixo do campo de código
  const codeInput = document.getElementById('code');
  if (!codeInput) return;
  const parent = codeInput.closest('.form-group') || codeInput.parentElement;

  // criar área de controles (timer + resend)
  const controls = document.createElement('div');
  controls.style.marginTop = '12px';
  controls.innerHTML = `
    <div id="2fa-controls" style="display:flex;align-items:center;gap:12px;">
      <div id="2fa-timer" style="font-size:14px;color:#666"></div>
      <button type="button" id="2fa-resend" class="btn btn-sm btn-link disabled" style="padding:0 8px;">Reenviar código</button>
    </div>
  `;
  parent.appendChild(controls);

  const resendBtn = document.getElementById('2fa-resend');

  // pega o email
  const email = await getEmailFor2FA();
  if (!email) {
    showNotification('Não foi possível recuperar seu email. Faça login novamente.', 'error', 6000);
    setTimeout(() => { window.location.href = '/login'; }, 1500);
    return;
  }

  // mostra onde o código foi enviado (placeholder)
  codeInput.placeholder = 'Código enviado para ' + maskEmail(email);

  // envia código inicialmente
  await send2FACode(email);

  // ligar evento de reenvio
  resendBtn.addEventListener('click', async () => {
    if (resendCooldown) return;
    await send2FACode(email);
  });

  // interceptar submit do formulário
  const form = codeInput.closest('form');
  if (form) {
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const code = (document.getElementById('code').value || '').trim();
      if (!code) {
        showNotification('Digite o código recebido por e-mail', 'error');
        return;
      }

      // desabilitar botão submit enquanto verifica
      const submitBtn = form.querySelector('button[type="submit"]');
      if (submitBtn) {
        submitBtn.disabled = true;
        const origText = submitBtn.textContent;
        submitBtn.textContent = 'Verificando...';
        const ok = await verify2FACode(email, code);
        submitBtn.textContent = origText;
        submitBtn.disabled = false;
        if (ok) {
          // verificação ok -> redireciona para painel
          window.location.href = '/painel';
        }
      } else {
        // sem botão detectado (improvável)
        const ok = await verify2FACode(email, code);
        if (ok) window.location.href = '/painel';
      }
    });
  }
}
</script>

</body>

</html>
